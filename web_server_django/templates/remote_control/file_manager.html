{% extends "layouts/base.html" %} {% block title %} File Manager {% endblock %}
{% block content %}

<div
  class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center py-4"
>
  <div class="d-block mb-4 mb-md-0">
    <h2 class="h4">Remote File Manager</h2>
  </div>
</div>

{% if is_connected %}

<div class="card card-body border-0 shadow table-wrapper table-responsive mb-4">
  <h5 class="mb-3">Drives</h5>
  <div id="drives-container" class="d-flex gap-2">
    <button class="btn btn-sm btn-secondary" disabled>Loading...</button>
  </div>
</div>

<div class="card card-body border-0 shadow table-wrapper table-responsive">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5 id="current-path-label" class="mb-0">Path: ...</h5>
    <button onclick="goUp()" class="btn btn-sm btn-secondary">
      ‚¨Ü Up Level
    </button>
  </div>

  <table class="table table-hover">
    <thead>
      <tr>
        <th class="border-gray-200">Type</th>
        <th class="border-gray-200">Name</th>
        <th class="border-gray-200">Size</th>
        <th class="border-gray-200">Action</th>
      </tr>
    </thead>
    <tbody id="file-list-body">
      <tr>
        <td colspan="4" class="text-center text-muted">Select a drive...</td>
      </tr>
    </tbody>
  </table>
</div>

{% else %}
<div class="text-center text-muted mt-5">
  <p>Vui l√≤ng ch·ªçn Server ƒë·ªÉ hi·ªÉn th·ªã d·ªØ li·ªáu.</p>
</div>
{% endif %} {% csrf_token %}

<script>
  let currentPath = "";

  // QUAN TR·ªåNG: Ch·ªâ ch·∫°y script khi Python b√°o ƒë√£ k·∫øt n·ªëi
  {% if is_connected %}
      document.addEventListener("DOMContentLoaded", function () {
        loadDrives();
      });
  {% endif %}

  function loadDrives() {
    fetch("/remote/api/file/drives/")
      .then((response) => response.json())
      .then((data) => {
        const container = document.getElementById("drives-container");
        if (!container) return;
        container.innerHTML = "";

        if (data.success && data.drives) {
          data.drives.forEach((drive) => {
            const btn = document.createElement("button");
            btn.className = "btn btn-outline-primary me-2";
            btn.innerHTML = `<i class="fas fa-hdd"></i> ${drive.path}`; // B·ªè ph·∫ßn info r∆∞·ªùm r√† n·∫øu mu·ªën
            btn.onclick = () => loadDirectory(drive.path);
            container.appendChild(btn);
          });
        }
      })
      .catch(err => console.error(err));
  }

  function loadDirectory(path) {
    currentPath = path;
    const label = document.getElementById("current-path-label");
    const tbody = document.getElementById("file-list-body");

    if(label) label.innerText = "Path: " + path;
    if(tbody) tbody.innerHTML = '<tr><td colspan="4" class="text-center">Loading...</td></tr>';

    fetch("/remote/api/file/list/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
      },
      body: JSON.stringify({ path: path }),
    })
      .then((response) => response.json())
      .then((data) => {
        if(!tbody) return;
        tbody.innerHTML = "";

        if (data.success && data.items) {
          if (data.items.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Empty Folder</td></tr>';
            return;
          }

          data.items.forEach((item) => {
            const tr = document.createElement("tr");
            let icon = item.type === "DIR" ? "üìÅ" : "üìÑ";
            // X·ª≠ l√Ω path an to√†n
            let safePath = currentPath.replace(/\\/g,"\\\\") + "\\\\" + item.name;

            let nameHtml = item.type === "DIR"
                ? `<a href="#" onclick="loadDirectory('${safePath}'); return false;" class="fw-bold text-decoration-none text-dark">${item.name}</a>`
                : item.name;

            let safeName = item.name.replace(/'/g, "\\'");
            let actionBtn = "";
            if (item.type === "FILE") {
              actionBtn = `<button class="btn btn-xs btn-success me-1" onclick="downloadFile('${safeName}')">‚¨á</button>`;
            }
            actionBtn += `<button class="btn btn-xs btn-danger" onclick="deleteItem('${safeName}')">üóë</button>`;

            tr.innerHTML = `<td>${icon}</td><td>${nameHtml}</td><td>${item.size}</td><td>${actionBtn}</td>`;
            tbody.appendChild(tr);
          });
        }
      });
  }

  function goUp() {
    if (!currentPath || currentPath.length <= 3) return;
    let parts = currentPath.split("\\");
    parts.pop();
    if (parts.length === 1 && parts[0].includes(":")) parts[0] += "\\";
    loadDirectory(parts.join("\\"));
  }

  function downloadFile(filename) {
    const fullPath = currentPath + "\\" + filename;
    fetch("/remote/api/file/download/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
      },
      body: JSON.stringify({ path: fullPath }),
    })
      .then((response) => {
        if (response.ok) return response.blob();
        throw new Error("Failed");
      })
      .then((blob) => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.style.display = "none";
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
      })
      .catch((err) => alert(err));
  }

  function deleteItem(name) {
    if (!confirm("Delete " + name + "?")) return;
    const fullPath = currentPath + "\\" + name;
    fetch("/remote/api/file/delete/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
      },
      body: JSON.stringify({ path: fullPath }),
    })
      .then((res) => res.json())
      .then((data) => {
        if (data.success) loadDirectory(currentPath);
      });
  }
</script>
{% endblock content %}
