{% extends 'layouts/base.html' %}
{% load static %}

{% block content %}
<div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800">Screen Recorder</h1>
    <span id="connection-status" class="badge badge-secondary shadow-sm">Connecting...</span>
</div>

<div class="row">

    <div class="col-xl-8 col-lg-7">
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">Live Screen Feed</h6>
                <div class="dropdown no-arrow">
                    <a class="dropdown-toggle" href="#" role="button" id="dropdownMenuLink"
                        data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="text-center">
                    <div id="stream-container" class="bg-dark rounded d-flex align-items-center justify-content-center mb-4" 
                         style="min-height: 450px; overflow: hidden; position: relative;">
                        
                        <div id="placeholder-container" class="text-white-50">
                            <i class="fas fa-desktop fa-4x mb-3"></i>
                            <p>Stream is currently OFF</p>
                        </div>

                        <img id="screen-feed" src="" style="width: 100%; height: auto; display: none;" alt="Live Feed">
                    </div>

                    <div class="user-select-none">
                        <button id="btn-turn-on" class="btn btn-success btn-icon-split btn-lg mr-2">
                            <span class="icon text-white-50">
                                <i class="fas fa-play"></i>
                            </span>
                            <span class="text">Turn On Screen</span>
                        </button>

                        <button id="btn-turn-off" class="btn btn-secondary btn-icon-split btn-lg mr-2" style="display: none;">
                            <span class="icon text-white-50">
                                <i class="fas fa-stop"></i>
                            </span>
                            <span class="text">Turn Off Screen</span>
                        </button>

                        <span class="mx-2">|</span>

                        <button id="btn-start-rec" class="btn btn-danger btn-icon-split btn-lg mr-2" disabled>
                            <span class="icon text-white-50">
                                <i class="fas fa-circle"></i>
                            </span>
                            <span class="text">Rec</span>
                        </button>

                        <button id="btn-stop-rec" class="btn btn-outline-danger btn-icon-split btn-lg" style="display: none;">
                            <span class="icon">
                                <i class="fas fa-square"></i>
                            </span>
                            <span class="text">Stop Rec</span>
                        </button>
                    </div>

                    <p id="status-msg" class="mt-3 small text-muted font-italic">&nbsp;</p>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-4 col-lg-5">
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">Saved Recordings</h6>
                <button class="btn btn-sm btn-primary shadow-sm" onclick="loadRecordings()">
                    <i class="fas fa-sync-alt fa-sm"></i>
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive" style="max-height: 550px; overflow-y: auto;">
                    <table class="table table-bordered table-hover" width="100%" cellspacing="0">
                        <thead class="thead-light">
                            <tr>
                                <th>Video Info</th>
                                <th class="text-center" style="width: 60px;">DL</th>
                            </tr>
                        </thead>
                        <tbody id="recording-list">
                            <tr><td colspan="2" class="text-center small">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        // --- API CONFIG (Hardcoded) ---
        const API_ON = "/remote/api/screen/on";
        const API_OFF = "/remote/api/screen/off";
        const API_STREAM = "/remote/api/screen/stream";
        const API_REC_START = "/remote/api/screen/record/start";
        const API_REC_STOP = "/remote/api/screen/record/stop";
        const API_LIST = "/remote/api/screen/list";
        const API_STATUS = "/remote/api/screen/status";

        // --- DOM Elements ---
        const btnOn = document.getElementById('btn-turn-on');
        const btnOff = document.getElementById('btn-turn-off');
        const btnStartRec = document.getElementById('btn-start-rec');
        const btnStopRec = document.getElementById('btn-stop-rec');
        
        const feedImg = document.getElementById('screen-feed');
        const placeholder = document.getElementById('placeholder-container');
        const statusMsg = document.getElementById('status-msg');
        const connectionBadge = document.getElementById('connection-status');
        const listBody = document.getElementById('recording-list');

        let streamInterval = null;

        // --- INITIALIZATION ---
        checkInitialStatus();
        loadRecordings();

        // --- EVENT LISTENERS ---

        // 1. TURN ON
        btnOn.onclick = function() {
            setLoading(true);
            updateStatus("Starting stream...", "text-info");
            
            fetch(API_ON, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        updateUI(true, false);
                        updateStatus("Stream Active", "text-success");
                    } else {
                        updateStatus("Error: " + data.message, "text-danger");
                        setLoading(false);
                    }
                })
                .catch(() => { updateStatus("Connection Failed", "text-danger"); setLoading(false); });
        };

        // 2. TURN OFF
        btnOff.onclick = function() {
            setLoading(true);
            stopStreamLoop(); // Stop fetching immediately
            
            fetch(API_OFF, { method: 'POST' })
                .then(res => res.json())
                .then(() => {
                    updateUI(false, false);
                    updateStatus("Stream Stopped", "text-secondary");
                });
        };

        // 3. START RECORDING
        btnStartRec.onclick = function() {
            updateStatus("Starting recording...", "text-warning");
            
            fetch(API_REC_START, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        updateUI(true, true);
                        updateStatus("Recording...", "text-danger font-weight-bold");
                    } else {
                        updateStatus("Rec Error: " + data.message, "text-danger");
                    }
                });
        };

        // 4. STOP RECORDING
        btnStopRec.onclick = function() {
            updateStatus("Saving video... Please wait...", "text-warning");
            btnStopRec.disabled = true; // Prevent double click
            
            fetch(API_REC_STOP, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        updateUI(true, false);
                        updateStatus("Saved: " + data.filename, "text-success");
                        loadRecordings(); // Reload list
                    } else {
                        updateStatus("Save Error: " + data.message, "text-danger");
                        btnStopRec.disabled = false;
                    }
                })
                .catch(() => {
                    updateStatus("Save Timeout (File might be large)", "text-danger");
                    btnStopRec.disabled = false; 
                });
        };

        // --- LOGIC FUNCTIONS ---

        function checkInitialStatus() {
            fetch(API_STATUS)
                .then(res => res.json())
                .then(data => {
                    updateUI(data.stream_on, data.recording);
                    connectionBadge.innerText = "Connected";
                    connectionBadge.className = "badge badge-success shadow-sm";
                })
                .catch(() => {
                    updateUI(false, false);
                    connectionBadge.innerText = "Disconnected";
                    connectionBadge.className = "badge badge-danger shadow-sm";
                });
        }

        function updateUI(isStreamOn, isRecording) {
            setLoading(false);

            if (isStreamOn) {
                // Show Feed
                placeholder.style.display = 'none';
                feedImg.style.display = 'block';
                startStreamLoop();

                // Buttons State
                btnOn.style.display = 'none';
                btnOff.style.display = 'inline-flex';

                if (isRecording) {
                    btnStartRec.style.display = 'none';
                    btnStopRec.style.display = 'inline-flex';
                    btnStopRec.disabled = false;
                    
                    // Visual cue for recording
                    feedImg.style.border = "3px solid #e74a3b"; // Red border
                } else {
                    btnStartRec.style.display = 'inline-flex';
                    btnStartRec.disabled = false;
                    btnStopRec.style.display = 'none';
                    
                    feedImg.style.border = "none";
                }
            } else {
                // Hide Feed
                placeholder.style.display = 'block';
                feedImg.style.display = 'none';
                stopStreamLoop();

                // Buttons State
                btnOn.style.display = 'inline-flex';
                btnOff.style.display = 'none';
                btnStartRec.style.display = 'inline-flex';
                btnStartRec.disabled = true;
                btnStopRec.style.display = 'none';
            }
        }

        // Tải danh sách file - Đã sửa nút Download
        function loadRecordings() {
            fetch(API_LIST)
                .then(res => res.json())
                .then(data => {
                    listBody.innerHTML = "";
                    if (data.success && data.recordings.length > 0) {
                        data.recordings.forEach(rec => {
                            // Tạo hàng (Row)
                            const tr = document.createElement('tr');
                            
                            // Cột thông tin (Tên file, ngày giờ, dung lượng)
                            const infoTd = `
                                <td>
                                    <div class="font-weight-bold text-primary text-truncate" style="max-width: 200px;" title="${rec.filename}">
                                        ${rec.filename}
                                    </div>
                                    <div class="small text-gray-500">
                                        <i class="far fa-clock"></i> ${rec.recorded_at} <br>
                                        <i class="far fa-file-video"></i> ${rec.file_size} • ${rec.duration}
                                    </div>
                                </td>`;
                            
                            // Cột nút Download (Y chang Webcam)
                            const actionTd = `
                                <td class="align-middle text-center">
                                    <a href="${rec.file_url}" target="_blank" class="btn btn-info btn-circle btn-sm" title="Download">
                                        <i class="fas fa-download"></i>
                                    </a>
                                </td>`;
                                
                            tr.innerHTML = infoTd + actionTd;
                            listBody.appendChild(tr);
                        });
                    } else {
                        listBody.innerHTML = '<tr><td colspan="2" class="text-center small text-gray-500 py-3">No recordings found</td></tr>';
                    }
                });
        }

        function startStreamLoop() {
            if (streamInterval) clearInterval(streamInterval);
            streamInterval = setInterval(() => {
                feedImg.src = API_STREAM + "?t=" + new Date().getTime();
            }, 200); // 5 FPS
        }

        function stopStreamLoop() {
            if (streamInterval) clearInterval(streamInterval);
            feedImg.src = "";
        }

        // --- ĐOẠN CODE MỚI CẦN THÊM VÀO ĐÂY ---
        // Expose hàm cleanup ra global window để thanh Navigation gọi được
        window.performScreenCleanup = function() {
            console.log("Disconnect detected -> Stopping Screen UI...");
            
            // 1. Dừng ngay lập tức việc tải ảnh
            stopStreamLoop();
            
            // 2. Reset giao diện về trạng thái Offline
            // Giả lập hành động bấm nút OFF
            if (btnOff) btnOff.click(); 
            
            // Hoặc set cứng UI nếu cần:
            if(placeholder) placeholder.style.display = 'block';
            if(feedImg) feedImg.style.display = 'none';
        };
        // ----------------------------------------

        function updateStatus(msg, cssClass) {
            statusMsg.className = "mt-3 small font-italic " + cssClass;
            statusMsg.innerText = msg;
        }

        function setLoading(isLoading) {
            if (isLoading) {
                btnOn.disabled = true;
                btnOff.disabled = true;
            } else {
                btnOn.disabled = false;
                btnOff.disabled = false;
            }
        }
    });
</script>

<style>
    /* CSS cho nút tròn (btn-circle) nếu theme chưa có */
    .btn-circle {
        border-radius: 100%;
        height: 2.5rem;
        width: 2.5rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }
    .btn-circle.btn-sm {
        height: 1.8rem;
        width: 1.8rem;
        font-size: 0.75rem;
    }
</style>
{% endblock %}