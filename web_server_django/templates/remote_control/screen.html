{% extends 'layouts/base.html' %}
{% load static %}

{% block title %}Screen Recorder{% endblock %}

{% block content %}
<div class="p-4 bg-white block sm:flex items-center justify-between border-b border-gray-200 lg:mt-1.5 dark:bg-gray-800 dark:border-gray-700">
  <div class="w-full mb-1">
    <div class="mb-4">
      <h1 class="text-xl font-semibold text-gray-900 sm:text-2xl dark:text-white">üñ•Ô∏è Screen Recorder</h1>
      <p class="text-sm text-gray-500 dark:text-gray-400">Remote screen monitoring and recording</p>
    </div>
  </div>
</div>

<div class="p-4">
  <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6 mb-6">
    <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Screen Controls</h2>
    
    <div class="mb-4">
      <div class="flex items-center space-x-4">
        <div class="flex items-center">
          <span class="text-sm font-medium text-gray-700 dark:text-gray-300 mr-2">Stream:</span>
          <span id="stream-status" class="text-sm font-semibold text-gray-500 dark:text-gray-400">‚ö™ OFF</span>
        </div>
        <div class="flex items-center">
          <span class="text-sm font-medium text-gray-700 dark:text-gray-300 mr-2">Recording:</span>
          <span id="recording-status" class="text-sm font-semibold text-gray-500 dark:text-gray-400">‚ö™ STOPPED</span>
        </div>
        <div id="duration-display" class="flex items-center hidden">
          <span class="text-sm font-medium text-gray-700 dark:text-gray-300 mr-2">Duration:</span>
          <span id="recording-duration" class="text-sm font-semibold text-red-600 dark:text-red-400">00:00:00</span>
        </div>
      </div>
    </div>
    
    <div class="flex space-x-3">
      <button id="turn-on-btn" type="button" class="text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5">
        ‚ñ∂ Start Stream
      </button>
      <button id="turn-off-btn" type="button" disabled class="text-white bg-gray-400 font-medium rounded-lg text-sm px-5 py-2.5 cursor-not-allowed">
        ‚èπ Stop Stream
      </button>
      <button id="start-rec-btn" type="button" disabled class="text-white bg-gray-400 font-medium rounded-lg text-sm px-5 py-2.5 cursor-not-allowed hidden">
        üî¥ Start Recording
      </button>
      <button id="stop-rec-btn" type="button" disabled class="text-white bg-gray-400 font-medium rounded-lg text-sm px-5 py-2.5 cursor-not-allowed hidden">
        ‚èπ Stop Recording
      </button>
      <button id="refresh-list-btn" type="button" class="text-gray-900 bg-white border border-gray-300 hover:bg-gray-100 font-medium rounded-lg text-sm px-5 py-2.5">
        üîÑ Refresh List
      </button>
    </div>
  </div>
  
  <div id="preview-container" class="bg-gray-900 shadow rounded-lg mb-6 hidden">
    <div class="p-4">
      <h2 class="text-lg font-semibold text-white mb-4">Live Screen Feed</h2>
      <div class="flex justify-center bg-black rounded-lg overflow-hidden">
        <img id="screen-preview" src="" alt="Screen Preview" class="max-w-full h-auto" style="max-height: 600px;">
      </div>
      <p class="text-sm text-gray-400 mt-2 text-center">Streaming Live</p>
    </div>
  </div>
  
  <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
    <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">üìº Recorded Screen Videos</h2>
    
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
        <thead class="bg-gray-50 dark:bg-gray-700">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date/Time</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Filename</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Duration</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Size</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
          </tr>
        </thead>
        <tbody id="recordings-list" class="bg-white divide-y divide-gray-200 dark:bg-gray-800 dark:divide-gray-700">
          <tr>
            <td colspan="5" class="px-6 py-4 text-center text-sm text-gray-500">Loading...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // --- CONFIG ---
  // ƒê·ªãnh nghƒ©a c√°c API endpoint t∆∞∆°ng ·ª©ng cho Screen
  const API = {
    ON: '/remote/api/screen/on',
    OFF: '/remote/api/screen/off',
    STREAM: '/remote/api/screen/stream',
    REC_START: '/remote/api/screen/record/start',
    REC_STOP: '/remote/api/screen/record/stop',
    LIST: '/remote/api/screen/list',
    STATUS: '/remote/api/screen/status',
    DELETE_BASE: '/remote/api/screen/delete/'
  };

  // --- DOM ELEMENTS ---
  const turnOnBtn = document.getElementById('turn-on-btn');
  const turnOffBtn = document.getElementById('turn-off-btn');
  const startRecBtn = document.getElementById('start-rec-btn');
  const stopRecBtn = document.getElementById('stop-rec-btn');
  const refreshListBtn = document.getElementById('refresh-list-btn');
  
  const streamStatus = document.getElementById('stream-status');
  const recordingStatus = document.getElementById('recording-status');
  const durationDisplay = document.getElementById('duration-display');
  const recordingDuration = document.getElementById('recording-duration');
  
  const previewContainer = document.getElementById('preview-container');
  const screenPreview = document.getElementById('screen-preview');
  const recordingsList = document.getElementById('recordings-list');
  
  // --- STATE ---
  let isStreamOn = false;
  let isRecording = false;
  let streamInterval = null;
  let durationInterval = null;
  let recordingStartTime = null;

  // Cleanup Global cho Navigation bar
  window.performScreenCleanup = function() {
        if (isStreamOn) {
            turnOffScreen(); 
        }
  };
  
  // --- UTILS ---
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  
  function updateDuration() {
    if (!recordingStartTime) return;
    const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
    const hours = Math.floor(elapsed / 3600);
    const minutes = Math.floor((elapsed % 3600) / 60);
    const seconds = elapsed % 60;
    recordingDuration.textContent = 
      `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
  }

  // --- ACTIONS ---
  async function turnOnScreen() {
    turnOnBtn.disabled = true; turnOnBtn.textContent = 'Connecting...';
    try {
      const res = await fetch(API.ON, { method: 'POST', headers: {'X-CSRFToken': getCookie('csrftoken')} });
      const data = await res.json();
      if (data.success || data.message.includes('already')) {
        isStreamOn = true;
        streamStatus.textContent = 'üü¢ ON'; streamStatus.classList.add('text-green-600');
        
        previewContainer.classList.remove('hidden');
        startRecBtn.classList.remove('hidden');
        
        turnOffBtn.disabled = false; turnOffBtn.classList.remove('bg-gray-400', 'cursor-not-allowed'); turnOffBtn.classList.add('bg-red-600', 'hover:bg-red-700');
        startRecBtn.disabled = false; startRecBtn.classList.remove('bg-gray-400', 'cursor-not-allowed'); startRecBtn.classList.add('bg-red-600', 'hover:bg-red-700');
        
        startStreaming();
      } else { alert('Error: ' + data.message); }
    } catch (e) { alert('Connection error'); }
    finally { turnOnBtn.disabled = false; turnOnBtn.textContent = '‚ñ∂ Start Stream'; }
  }
  
  async function turnOffScreen() {
    try {
      if (isRecording) await stopRecording();
      await fetch(API.OFF, { method: 'POST', headers: {'X-CSRFToken': getCookie('csrftoken')} });
      
      isStreamOn = false;
      streamStatus.textContent = '‚ö™ OFF'; streamStatus.classList.remove('text-green-600');
      
      previewContainer.classList.add('hidden');
      startRecBtn.classList.add('hidden');
      stopRecBtn.classList.add('hidden');
      
      turnOffBtn.disabled = true; turnOffBtn.classList.add('bg-gray-400', 'cursor-not-allowed'); turnOffBtn.classList.remove('bg-red-600');
      stopStreaming();
    } catch (e) { console.error(e); }
  }

  function startStreaming() {
    if(streamInterval) clearInterval(streamInterval);
    // Refresh ·∫£nh m·ªói 200ms (5 FPS) ƒë·ªÉ ƒë·ª° lag m·∫°ng, v√¨ ·∫£nh m√†n h√¨nh n·∫∑ng h∆°n webcam
    streamInterval = setInterval(() => {
        screenPreview.src = API.STREAM + "?t=" + new Date().getTime();
    }, 200); 
  }
  
  function stopStreaming() {
    if (streamInterval) clearInterval(streamInterval);
    screenPreview.src = '';
  }

  async function startRecording() {
    startRecBtn.disabled = true;
    try {
      const res = await fetch(API.REC_START, { method: 'POST', headers: {'X-CSRFToken': getCookie('csrftoken')} });
      const data = await res.json();
      if (data.success) {
        isRecording = true;
        recordingStatus.textContent = 'üî¥ RECORDING'; recordingStatus.classList.add('text-red-600');
        durationDisplay.classList.remove('hidden');
        recordingStartTime = Date.now();
        durationInterval = setInterval(updateDuration, 1000);
        
        startRecBtn.classList.add('hidden');
        stopRecBtn.classList.remove('hidden');
        stopRecBtn.disabled = false; stopRecBtn.classList.remove('bg-gray-400'); stopRecBtn.classList.add('bg-red-600');
      } else { alert(data.message); }
    } catch (e) { alert('Error starting record'); }
    finally { startRecBtn.disabled = false; }
  }

  async function stopRecording() {
    stopRecBtn.disabled = true; stopRecBtn.textContent = 'Saving...';
    try {
      const res = await fetch(API.REC_STOP, { method: 'POST', headers: {'X-CSRFToken': getCookie('csrftoken')} });
      const data = await res.json();
      if (data.success) {
        isRecording = false;
        recordingStatus.textContent = '‚ö™ STOPPED'; recordingStatus.classList.remove('text-red-600');
        durationDisplay.classList.add('hidden');
        if(durationInterval) clearInterval(durationInterval);
        
        stopRecBtn.classList.add('hidden');
        startRecBtn.classList.remove('hidden');
        
        loadRecordingsList(); // Reload table
        alert(`Saved: ${data.filename} (${data.file_size})`);
      } else { alert(data.message); }
    } catch (e) { alert('Error stopping record'); }
    finally { stopRecBtn.disabled = false; stopRecBtn.textContent = '‚èπ Stop Recording'; }
  }

  // --- LIST ---
  async function loadRecordingsList() {
    try {
      const res = await fetch(API.LIST);
      const data = await res.json();
      const listBody = document.getElementById('recordings-list'); // ƒê·∫£m b·∫£o ID n√†y ƒë√∫ng v·ªõi HTML
      if (data.success && data.recordings.length > 0) {
        listBody.innerHTML = data.recordings.map(rec => `
          <tr>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${rec.recorded_at}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${rec.filename}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${rec.duration}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${rec.file_size}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                <a href="${rec.file_url}" target="_blank" class="text-blue-600 hover:text-blue-900 mr-3">View</a>
                <a href="${rec.file_url}" download class="text-green-600 hover:text-green-900 mr-3">Download</a>
                
                <button onclick="deleteRecording(${rec.id})" class="text-red-600 hover:text-red-900 font-bold">Delete</button>
            </td>
          </tr>
        `).join('');
      } else {
        listBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-sm text-gray-500">No recordings yet.</td></tr>';
      }
    } catch (e) { console.error(e); }
  }

  // 3. TH√äM H√ÄM X·ª¨ L√ù X√ìA (EXPOSE RA GLOBAL WINDOW)
  window.deleteRecording = async function(id) {
    if (!confirm('Are you sure you want to delete this screen recording?')) return;
    
    try {
      const response = await fetch(API.DELETE_BASE + id + '/', {
        method: 'DELETE',
        headers: {
          'X-CSRFToken': getCookie('csrftoken') // H√†m getCookie ƒë√£ c√≥ ·ªü ƒëo·∫°n code tr∆∞·ªõc
        }
      });
      
      const data = await response.json();
      
      if (data.success) {
        // X√≥a th√†nh c√¥ng th√¨ load l·∫°i danh s√°ch
        loadRecordingsList();
      } else {
        alert("Delete failed: " + data.message);
      }
    } catch (error) {
      alert("Error: " + error);
    }
  };

  // --- INIT ---
  refreshListBtn.addEventListener('click', loadRecordingsList);
  turnOnBtn.addEventListener('click', turnOnScreen);
  turnOffBtn.addEventListener('click', turnOffScreen);
  startRecBtn.addEventListener('click', startRecording);
  stopRecBtn.addEventListener('click', stopRecording);
  
  loadRecordingsList();
  
  // Check Status Periodically
  setInterval(async () => {
      try {
        const res = await fetch(API.STATUS);
        const data = await res.json();
        // Sync logic n·∫øu state thay ƒë·ªïi t·ª´ b√™n ngo√†i (optional)
      } catch (e) {}
  }, 3000);
});
</script>
{% endblock %}