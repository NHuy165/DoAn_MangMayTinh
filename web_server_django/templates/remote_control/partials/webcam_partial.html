<!-- Main Content -->
<main data-page="webcam">
    <div class="px-4 pt-6">
        <div class="grid gap-4 xl:grid-cols-1 2xl:grid-cols-2">
            <!-- Camera Controls -->
            <div class="p-4 bg-white border border-gray-200 rounded-lg shadow-sm 2xl:col-span-2 dark:border-gray-700 sm:p-6 dark:bg-gray-800">
                <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Camera Controls</h2>
                
                <!-- Status Display -->
                <div class="mb-4">
                <div class="flex items-center space-x-4">
                    <div class="flex items-center">
                    <span class="text-sm font-medium text-gray-700 dark:text-gray-300 mr-2">Camera:</span>
                    <span id="camera-status" class="text-sm font-semibold text-gray-500 dark:text-gray-400">‚ö™ OFF</span>
                    </div>
                    <div class="flex items-center">
                    <span class="text-sm font-medium text-gray-700 dark:text-gray-300 mr-2">Recording:</span>
                    <span id="recording-status" class="text-sm font-semibold text-gray-500 dark:text-gray-400">‚ö™ STOPPED</span>
                    </div>
                    <div id="duration-display" class="flex items-center hidden">
                    <span class="text-sm font-medium text-gray-700 dark:text-gray-300 mr-2">Duration:</span>
                    <span id="recording-duration" class="text-sm font-semibold text-red-600 dark:text-red-400">00:00:00</span>
                    </div>
                </div>
                </div>
                
                <!-- Control Buttons -->
                <div class="flex space-x-3">
                <button id="turn-on-btn" type="button" class="text-gray-800 dark:text-white bg-green-600 hover:bg-green-700 focus:ring-4 focus:ring-green-300 font-medium rounded-lg text-sm px-5 py-2.5 dark:bg-green-500 dark:hover:bg-green-600 focus:outline-none dark:focus:ring-green-800">
                    üì∑ Turn On Camera
                </button>
                <button id="turn-off-btn" type="button" disabled class="text-gray-800 dark:text-white bg-gray-400 font-medium rounded-lg text-sm px-5 py-2.5 cursor-not-allowed">
                    ‚èπ Turn Off Camera
                </button>
                <button id="start-rec-btn" type="button" disabled class="text-gray-800 dark:text-white bg-gray-400 font-medium rounded-lg text-sm px-5 py-2.5 cursor-not-allowed hidden">
                    üî¥ Start Recording
                </button>
                <button id="stop-rec-btn" type="button" disabled class="text-gray-800 dark:text-white bg-gray-400 font-medium rounded-lg text-sm px-5 py-2.5 cursor-not-allowed hidden">
                    ‚èπ Stop Recording
                </button>
                <button id="refresh-list-btn" type="button" class="text-gray-900 bg-white border border-gray-300 hover:bg-gray-100 focus:ring-4 focus:ring-gray-200 font-medium rounded-lg text-sm px-5 py-2.5 dark:bg-gray-800 dark:text-white dark:border-gray-600 dark:hover:bg-gray-700 dark:hover:border-gray-600 dark:focus:ring-gray-700">
                    üîÑ Refresh List
                </button>
                </div>
            </div>
            
            <!-- Live Preview -->
            <div id="preview-container" class="bg-gray-900 shadow rounded-lg mb-6 hidden">
                <div class="p-4">
                <h2 class="text-lg font-semibold text-white mb-4">Live Preview</h2>
                <div class="flex justify-center bg-black rounded-lg overflow-hidden">
                    <img id="webcam-preview" src="" alt="Webcam Preview" class="max-w-full h-auto" style="max-height: 600px;">
                </div>
                <p class="text-sm text-gray-400 mt-2 text-center">Streaming at ~30 FPS</p>
                </div>
            </div>
            
            <!-- Recordings List -->
            <div class="p-4 bg-white border border-gray-200 rounded-lg shadow-sm 2xl:col-span-2 dark:border-gray-700 sm:p-6 dark:bg-gray-800">
                <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">üìπ Recorded Videos</h2>
                
                <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <thead class="bg-gray-50 dark:bg-gray-700">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                        Date/Time
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                        Filename
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                        Duration
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                        Size
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                        Actions
                        </th>
                    </tr>
                    </thead>
                    <tbody id="recordings-list" class="bg-white divide-y divide-gray-200 dark:bg-gray-800 dark:divide-gray-700">
                    <tr>
                        <td colspan="5" class="px-6 py-4 text-center text-sm text-gray-500 dark:text-gray-400">
                        No recordings yet. Start recording to create your first video.
                        </td>
                    </tr>
                    </tbody>
                </table>
                </div>
            </div>
            </div>
        </div>
</main>

<script>
    function initWebcamPage() {
        if (!document.querySelector('[data-page="webcam"]')) return;

        // ==================== DOM ELEMENTS ====================
        const turnOnBtn = document.getElementById('turn-on-btn');
        const turnOffBtn = document.getElementById('turn-off-btn');
        const startRecBtn = document.getElementById('start-rec-btn');
        const stopRecBtn = document.getElementById('stop-rec-btn');
        const refreshListBtn = document.getElementById('refresh-list-btn');
        
        const cameraStatus = document.getElementById('camera-status');
        const recordingStatus = document.getElementById('recording-status');
        const durationDisplay = document.getElementById('duration-display');
        const recordingDuration = document.getElementById('recording-duration');
        
        const previewContainer = document.getElementById('preview-container');
        const webcamPreview = document.getElementById('webcam-preview');
        const recordingsList = document.getElementById('recordings-list');

        // ==================== STATE VARIABLES ====================
        let isCameraOn = false;
        let isRecording = false;
        let streamInterval = null;
        let durationInterval = null;
        let recordingStartTime = null;

        // Utility function to help with auto camera turnoff

        window.performWebcamCleanup = function() {
                if (isCameraOn) {
                    console.log("Disconnect detected -> Stopping Webcam UI...");
                    
                    // 1. Quan tr·ªçng nh·∫•t: Ng·∫Øt v√≤ng l·∫∑p l·∫•y ·∫£nh ngay l·∫≠p t·ª©c
                    isCameraOn = false; 

                    // 2. G·ªçi h√†m t·∫Øt camera c√≥ s·∫µn c·ªßa b·∫°n ƒë·ªÉ reset giao di·ªán
                    if (typeof turnOffCamera === 'function') {
                        turnOffCamera(); 
                    }
                }
        };
        
        // ==================== UTILITY FUNCTIONS ====================
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
                }
            }
            }
            return cookieValue;
        }
        
        //   function showNotification(type, message) {
        //     const colors = {'success': '‚úì', 'error': '‚úó', 'info': '‚Ñπ'};
        //     alert(`${colors[type] || ''} ${message}`);
        //   }
        
        function updateDuration() {
            if (!recordingStartTime) return;
            const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
            const hours = Math.floor(elapsed / 3600);
            const minutes = Math.floor((elapsed % 3600) / 60);
            const seconds = elapsed % 60;
            recordingDuration.textContent = 
            `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        // ==================== CAMERA CONTROL ====================
        async function turnOnCamera() {
            const activeStream = localStorage.getItem('ACTIVE_STREAM_MODE');
            if (activeStream === 'SCREEN') {
                alert("Cannot start Webcam: Screen Recorder is currently active! Please turn off Screen Recorder first.");
                return;
            }

            turnOnBtn.disabled = true;
            turnOnBtn.textContent = 'Turning On...';
            
            try {
            const response = await fetch('/remote/api/webcam/on/', {
                method: 'POST',
                headers: {
                'X-CSRFToken': getCookie('csrftoken')
                }
            });
            
            const data = await response.json();
            
            // Success ho·∫∑c camera ƒë√£ b·∫≠t r·ªìi ‚Üí Coi nh∆∞ th√†nh c√¥ng
            if (data.success || data.message.includes('already ON')) {
                isCameraOn = true;
                
                // --- SET GLOBAL LOCK ---
                localStorage.setItem('ACTIVE_STREAM_MODE', 'WEBCAM');

                cameraStatus.textContent = 'üü¢ ON';
                cameraStatus.classList.add('text-green-600');
                
                // Show preview and recording controls
                previewContainer.classList.remove('hidden');
                startRecBtn.classList.remove('hidden');
                
                // Enable buttons
                turnOffBtn.disabled = false;
                turnOffBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                turnOffBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                
                startRecBtn.disabled = false;
                startRecBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                startRecBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                
                // Start streaming preview
                startStreaming();
                
                showNotification('success', data.success ? 'Camera turned on' : 'Camera already on, streaming started');
            } else {
                showNotification('error', data.message);
            }
            } catch (error) {
            showNotification('error', 'Failed to turn on camera: ' + error.message);
            } finally {
            turnOnBtn.disabled = false;
            turnOnBtn.textContent = 'üì∑ Turn On Camera';
            }
        }
        
        async function turnOffCamera() {
            turnOffBtn.disabled = true;
            turnOffBtn.textContent = 'Turning Off...';
            
            try {
            // Stop recording if active
            if (isRecording) {
                await stopRecording();
            }
            
            const response = await fetch('/remote/api/webcam/off/', {
                method: 'POST',
                headers: {
                'X-CSRFToken': getCookie('csrftoken')
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                isCameraOn = false;

                // --- REMOVE GLOBAL LOCK ---
                localStorage.removeItem('ACTIVE_STREAM_MODE');


                cameraStatus.textContent = '‚ö™ OFF';
                cameraStatus.classList.remove('text-green-600');
                
                // Hide preview and recording controls
                previewContainer.classList.add('hidden');
                startRecBtn.classList.add('hidden');
                stopRecBtn.classList.add('hidden');
                
                // Update button states
                turnOffBtn.disabled = true;
                turnOffBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                turnOffBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                
                turnOnBtn.disabled = false;
                turnOnBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                turnOnBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                
                // Stop streaming
                stopStreaming();
                
                showNotification("info", 'Camera turned off');
            } else {
                showNotification('error', data.message);
            }
            } catch (error) {
            showNotification('error', 'Failed to turn off camera: ' + error.message);
            } finally {
            turnOffBtn.textContent = '‚èπ Turn Off Camera';
            }
        }
        
        // ==================== STREAMING ====================
        function startStreaming() {
            // Update frame every ~33ms (30 FPS)
            streamInterval = setInterval(async () => {
            try {
                const response = await fetch('/remote/api/webcam/stream/');
                if (response.ok) {
                const blob = await response.blob();
                webcamPreview.src = URL.createObjectURL(blob);
                }
            } catch (error) {
                console.error('Streaming error:', error);
            }
            }, 33);
        }
        
        function stopStreaming() {
            if (streamInterval) {
            clearInterval(streamInterval);
            streamInterval = null;
            }
            webcamPreview.src = '';
        }
        
        // ==================== RECORDING CONTROL ====================
        async function startRecording() {
            startRecBtn.disabled = true;
            startRecBtn.textContent = 'Starting...';
            
            try {
            const response = await fetch('/remote/api/webcam/start-recording/', {
                method: 'POST',
                headers: {
                'X-CSRFToken': getCookie('csrftoken')
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                isRecording = true;
                recordingStatus.textContent = 'üî¥ RECORDING';
                recordingStatus.classList.add('text-red-600');
                
                // Show duration and start timer
                durationDisplay.classList.remove('hidden');
                recordingStartTime = Date.now();
                durationInterval = setInterval(updateDuration, 1000);
                
                // Show stop button, hide start button
                startRecBtn.classList.add('hidden');
                stopRecBtn.classList.remove('hidden');
                stopRecBtn.disabled = false;
                stopRecBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                stopRecBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                
                showNotification('success', 'Recording started');
            } else {
                showNotification('error', data.message);
            }
            } catch (error) {
            showNotification('error', 'Failed to start recording: ' + error.message);
            } finally {
            startRecBtn.disabled = false;
            startRecBtn.textContent = 'üî¥ Start Recording';
            }
        }
        
        async function stopRecording() {
            stopRecBtn.disabled = true;
            stopRecBtn.textContent = 'Stopping...';
            
            try {
            const response = await fetch('/remote/api/webcam/stop-recording/', {
                method: 'POST',
                headers: {
                'X-CSRFToken': getCookie('csrftoken')
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                isRecording = false;
                recordingStatus.textContent = '‚ö™ STOPPED';
                recordingStatus.classList.remove('text-red-600');
                
                // Hide duration
                durationDisplay.classList.add('hidden');
                if (durationInterval) {
                clearInterval(durationInterval);
                durationInterval = null;
                }
                recordingStartTime = null;
                recordingDuration.textContent = '00:00:00';
                
                // Show start button, hide stop button
                stopRecBtn.classList.add('hidden');
                startRecBtn.classList.remove('hidden');
                startRecBtn.disabled = false;
                
                // Refresh recordings list
                await loadRecordingsList();
                
                showNotification('success', `Recording saved: ${data.file_size}`);
            } else {
                showNotification('error', data.message);
            }
            } catch (error) {
            showNotification('error', 'Failed to stop recording: ' + error.message);
            } finally {
            stopRecBtn.disabled = false;
            stopRecBtn.textContent = '‚èπ Stop Recording';
            }
        }
        
        // ==================== RECORDINGS LIST ====================
        async function loadRecordingsList() {
            try {
            const response = await fetch('/remote/api/webcam/list/');
            const data = await response.json();
            
            if (data.success && data.recordings.length > 0) {
                recordingsList.innerHTML = data.recordings.map(rec => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">
                    ${rec.recorded_at}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                    ${rec.filename}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                    ${rec.duration}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                    ${rec.file_size}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <a href="${rec.file_url}" target="_blank" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 mr-3">View</a>
                    <a href="${rec.file_url}" download class="text-green-600 hover:text-green-900 dark:text-green-400 mr-3">Download</a>
                    <button onclick="deleteRecording(${rec.id})" class="text-red-600 hover:text-red-900 dark:text-red-400">Delete</button>
                    </td>
                </tr>
                `).join('');
            } else {
                recordingsList.innerHTML = `
                <tr>
                    <td colspan="5" class="px-6 py-4 text-center text-sm text-gray-500 dark:text-gray-400">
                    No recordings yet. Start recording to create your first video.
                    </td>
                </tr>
                `;
            }
            } catch (error) {
            console.error('Failed to load recordings:', error);
            }
        }
        
        window.deleteRecording = async function(id) {
            if (!confirm('Are you sure you want to delete this recording?')) return;
            
            try {
            const response = await fetch(`/remote/api/webcam/delete/${id}/`, {
                method: 'DELETE',
                headers: {
                'X-CSRFToken': getCookie('csrftoken')
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                showNotification('success', 'Recording deleted');
                await loadRecordingsList();
            } else {
                showNotification('error', data.message);
            }
            } catch (error) {
            showNotification('error', 'Failed to delete recording: ' + error.message);
            }
        };
        
        // ==================== STATUS POLLING ====================
        async function updateStatus() {
            try {
            const response = await fetch('/remote/api/webcam/status/');
            const data = await response.json();
            
            // Sync UI with actual status
            if (data.camera_on !== isCameraOn) {
                // Camera state changed externally
                if (data.camera_on) {
                cameraStatus.textContent = 'üü¢ ON';
                cameraStatus.classList.add('text-green-600');
                } else {
                cameraStatus.textContent = '‚ö™ OFF';
                cameraStatus.classList.remove('text-green-600');
                }
                isCameraOn = data.camera_on;
            }
            
            if (data.recording !== isRecording) {
                // Recording state changed externally
                if (data.recording) {
                recordingStatus.textContent = 'üî¥ RECORDING';
                recordingStatus.classList.add('text-red-600');
                } else {
                recordingStatus.textContent = '‚ö™ STOPPED';
                recordingStatus.classList.remove('text-red-600');
                }
                isRecording = data.recording;
            }
            } catch (error) {
            console.error('Status update error:', error);
            }
        }
        
        // ==================== EVENT LISTENERS ====================
        if (turnOnBtn) turnOnBtn.onclick = turnOnCamera;
        if (turnOffBtn) turnOffBtn.onclick = turnOffCamera;
        if (startRecBtn) startRecBtn.onclick = startRecording;
        if (stopRecBtn) stopRecBtn.onclick = stopRecording;
        if (refreshListBtn) refreshListBtn.onclick = loadRecordingsList;
        
        // ==================== INITIALIZATION ====================
        // Load recordings list on page load
        loadRecordingsList();
        
        // Poll status every 3 seconds
        const webcamStatusInterval = setInterval(() => {
            // Ki·ªÉm tra: N·∫øu kh√¥ng t√¨m th·∫•y trang webcam (ƒë√£ chuy·ªÉn tab)
            if (!document.querySelector('[data-page="webcam"]')) {
                console.log("Webcam tab closed -> Killing status timer");
                clearInterval(webcamStatusInterval); // D·ª´ng v√≤ng l·∫∑p
                return;
            }
            
            updateStatus();
        }, 3000);
        
        // Initial status check
        updateStatus();
    }

initWebcamPage();
</script>