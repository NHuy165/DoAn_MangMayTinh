<main data-page="processes">
    <div class="px-4 pt-6">
        <!-- Running Processes -->
        <div class="p-4 mb-4 bg-white border border-gray-200 rounded-lg shadow-sm dark:border-gray-700 sm:p-6 dark:bg-gray-800">
            <div class="items-center justify-between mb-4 lg:flex">
                <div class="mb-4 lg:mb-0">
                    <h3 class="mb-2 text-xl font-bold text-gray-900 dark:text-white">Running Processes</h3>
                    <span class="text-base font-normal text-gray-500 dark:text-gray-400">All processes currently running on target machine</span>
                </div>
                <div class="flex items-center">
                    <button onclick="loadProcesses()" 
                        class="inline-flex items-center px-3 py-2 text-sm font-medium text-center text-white rounded-lg bg-primary-700 hover:bg-primary-800 focus:ring-4 focus:ring-primary-300 dark:bg-primary-600 dark:hover:bg-primary-700 dark:focus:ring-primary-800">
                        Refresh
                    </button>
                </div>
            </div>
            
            <div class="flex flex-col mt-6">
                <div class="overflow-x-auto rounded-lg" style="max-height: 500px; overflow-y: auto;">
                    <div class="inline-block min-w-full align-middle">
                        <div class="overflow-hidden shadow sm:rounded-lg">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-600">
                                <thead class="bg-gray-50 dark:bg-gray-700 sticky top-0 z-10">
                                    <tr>
                                        <th scope="col" class="p-4 text-xs font-medium tracking-wider text-left text-gray-500 uppercase dark:text-white">
                                            Process Name
                                        </th>
                                        <th scope="col" class="p-4 text-xs font-medium tracking-wider text-left text-gray-500 uppercase dark:text-white">
                                            PID
                                        </th>
                                        <th scope="col" class="p-4 text-xs font-medium tracking-wider text-left text-gray-500 uppercase dark:text-white">
                                            Threads
                                        </th>
                                        <th scope="col" class="p-4 text-xs font-medium tracking-wider text-left text-gray-500 uppercase dark:text-white">
                                            Action
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="runningProcessesBody" class="bg-white dark:bg-gray-800">
                                    <tr>
                                        <td colspan="4" class="p-4 text-sm text-center text-gray-500 dark:text-gray-400">
                                            Click "Refresh" to load running processes
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Available Processes -->
        <div class="p-4 bg-white border border-gray-200 rounded-lg shadow-sm dark:border-gray-700 sm:p-6 dark:bg-gray-800">
            <div class="items-center justify-between mb-4 lg:flex">
                <div class="mb-4 lg:mb-0">
                    <h3 class="mb-2 text-xl font-bold text-gray-900 dark:text-white">Available Processes</h3>
                    <span class="text-base font-normal text-gray-500 dark:text-gray-400">Common system processes not currently running</span>
                </div>
                <div class="flex items-center space-x-2">
                    <input type="text" id="searchProcess" 
                        class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500"
                        placeholder="Search or enter process name...">
                    <button onclick="startNewProcess()"
                        class="inline-flex items-center px-3 py-2 text-sm font-medium text-center text-white rounded-lg bg-green-600 hover:bg-green-700 focus:ring-4 focus:ring-green-300 dark:bg-green-500 dark:hover:bg-green-600 dark:focus:ring-green-800">
                        Start
                    </button>
                </div>
            </div>
            
            <div class="flex flex-col mt-6">
                <div class="overflow-x-auto rounded-lg" style="max-height: 400px; overflow-y: auto;">
                    <div class="inline-block min-w-full align-middle">
                        <div class="overflow-hidden shadow sm:rounded-lg">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-600">
                                <thead class="bg-gray-50 dark:bg-gray-700 sticky top-0 z-10">
                                    <tr>
                                        <th scope="col" class="p-4 text-xs font-medium tracking-wider text-left text-gray-500 uppercase dark:text-white">
                                            Process Name
                                        </th>
                                        <th scope="col" class="p-4 text-xs font-medium tracking-wider text-left text-gray-500 uppercase dark:text-white">
                                            Description
                                        </th>
                                        <th scope="col" class="p-4 text-xs font-medium tracking-wider text-left text-gray-500 uppercase dark:text-white">
                                            Action
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="availableProcessesBody" class="bg-white dark:bg-gray-800">
                                    <tr>
                                        <td colspan="3" class="p-4 text-sm text-center text-gray-500 dark:text-gray-400">
                                            Click "Refresh" to load available processes
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>


<script>
    // Common system processes
    const commonProcesses = [
        {name: 'calc.exe', description: 'Calculator'},
        {name: 'notepad.exe', description: 'Notepad'},
        {name: 'mspaint.exe', description: 'Paint'},
        {name: 'cmd.exe', description: 'Command Prompt'},
        {name: 'powershell.exe', description: 'PowerShell'},
        {name: 'taskmgr.exe', description: 'Task Manager'},
        {name: 'explorer.exe', description: 'Windows Explorer'},
        {name: 'chrome.exe', description: 'Google Chrome'},
        {name: 'msedge.exe', description: 'Microsoft Edge'},
        {name: 'firefox.exe', description: 'Mozilla Firefox'}
    ];

    // Load running processes
    async function loadProcesses() {
        const runningTbody = document.getElementById('runningProcessesBody');
        runningTbody.innerHTML = '<tr><td colspan="4" class="p-4 text-sm text-center text-gray-500 dark:text-gray-400">Loading...</td></tr>';
        
        const data = await apiCall('/remote/api/process/list/');
        runningTbody.innerHTML = '';
        
        let runningProcessNames = [];
        
        if (data.status === 'success' && data.data && data.data.length > 0) {
            data.data.forEach((proc, index) => {
                const rowClass = index % 2 === 0 ? '' : 'bg-gray-50 dark:bg-gray-700';
                runningTbody.innerHTML += `
                    <tr class="${rowClass}">
                        <td class="p-4 text-sm font-normal text-gray-900 whitespace-nowrap dark:text-white">
                            ${proc.name}
                        </td>
                        <td class="p-4 text-sm font-normal text-gray-500 whitespace-nowrap dark:text-gray-400">
                            ${proc.id}
                        </td>
                        <td class="p-4 text-sm font-semibold text-gray-900 whitespace-nowrap dark:text-white">
                            ${proc.threads}
                        </td>
                        <td class="p-4 whitespace-nowrap">
                            <button onclick="killProcess('${proc.id}', '${proc.name}')" 
                                class="inline-flex items-center px-3 py-2 text-sm font-medium text-center text-white bg-red-600 rounded-lg hover:bg-red-700 focus:ring-4 focus:ring-red-300 dark:bg-red-500 dark:hover:bg-red-600 dark:focus:ring-red-800">
                                End Task
                            </button>
                        </td>
                    </tr>`;
                
                // Lưu tên process đang chạy (lowercase để so sánh)
                runningProcessNames.push(proc.name.toLowerCase());
            });
        } else {
            runningTbody.innerHTML = '<tr><td colspan="4" class="p-4 text-sm text-center text-gray-500 dark:text-gray-400">No running processes or connection error</td></tr>';
        }
        
        // Update available processes list (lọc các process chưa chạy)
        loadAvailableProcesses(runningProcessNames);
    }

    // Load available processes (not running)
    function loadAvailableProcesses(runningProcessNames = []) {
        const tbody = document.getElementById('availableProcessesBody');
        tbody.innerHTML = '';
        
        // Lọc các process chưa chạy
        const availableProcesses = commonProcesses.filter(proc => {
            const procNameLower = proc.name.toLowerCase();
            return !runningProcessNames.some(running => 
                running.includes(procNameLower) || procNameLower.includes(running)
            );
        });
        
        if (availableProcesses.length > 0) {
            availableProcesses.forEach((proc, index) => {
                const rowClass = index % 2 === 0 ? '' : 'bg-gray-50 dark:bg-gray-700';
                tbody.innerHTML += `
                    <tr class="${rowClass}">
                        <td class="p-4 text-sm font-normal text-gray-900 whitespace-nowrap dark:text-white">
                            ${proc.name}
                        </td>
                        <td class="p-4 text-sm font-normal text-gray-500 whitespace-nowrap dark:text-gray-400">
                            ${proc.description}
                        </td>
                        <td class="p-4 whitespace-nowrap">
                            <button onclick="startProcess('${proc.name}')" 
                                class="inline-flex items-center px-3 py-2 text-sm font-medium text-center text-white bg-red-600 rounded-lg hover:bg-red-700 focus:ring-4 focus:ring-red-300 dark:bg-red-500 dark:hover:bg-red-600 dark:focus:ring-red-800">
                                Start
                            </button>
                        </td>
                    </tr>`;
            });
        } else {
            tbody.innerHTML = '<tr><td colspan="3" class="p-4 text-sm text-center text-gray-500 dark:text-gray-400">All common processes are already running</td></tr>';
        }
    }

    // Start process
    async function startProcess(processName) {
        const res = await apiCall('/remote/api/process/start/', 'POST', {name: processName});
        
        if (res.status === 'success') {
            showAlert(res.message || 'Process started successfully');
            setTimeout(() => loadProcesses(), 1500);
        } else {
            showAlert(res.message || 'Failed to start process');
        }
    }

    // Start new custom process
    async function startNewProcess() {
        const name = document.getElementById('searchProcess').value.trim();
        if (!name) {
            showAlert('Please enter process name');
            return;
        }
        
        await startProcess(name);
        document.getElementById('searchProcess').value = '';
    }

    // Kill process
    async function killProcess(pid, name) {
        if (!confirm(`End task "${name}" (PID: ${pid})?`)) {
            return;
        }
        
        const res = await apiCall('/remote/api/process/kill/', 'POST', {id: pid});
        
        if (res.status === 'success') {
            showAlert(res.message || 'Process terminated successfully');
            setTimeout(() => loadProcesses(), 1000);
        } else {
            showAlert(res.message || 'Failed to terminate process');
        }
    }

    // Enter key handler
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('searchProcess').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') startNewProcess();
        });
        
        // Không load gì khi mới vào trang - chờ user bấm Refresh
    });
</script>

<script>
    // Common API call function
    async function apiCall(url, method='GET', body=null) {
        const options = { 
            method: method, 
            headers: {'Content-Type': 'application/json'} 
        };
        if (body) options.body = JSON.stringify(body);
        
        try {
            const res = await fetch(url, options);
            return await res.json();
        } catch (err) {
            console.error(err);
            return { status: 'error', message: 'Connection Error' };
        }
    }

    // Show alert helper
    function showAlert(message, type = 'info') {
        alert(message);
    }
</script>