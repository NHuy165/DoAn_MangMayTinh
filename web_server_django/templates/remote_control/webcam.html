  {% extends 'layouts/base.html' %}
  {% load static %}

  {% block title %}Webcam Control{% endblock %}

  {% block content %}
  <!-- Main Content -->
  <div class="p-4">
    <!-- Camera Controls -->
    <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6 mb-6">
      <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Camera Controls</h2>
      
      <!-- Status Display -->
      <div class="mb-4">
        <div class="flex items-center space-x-4">
          <div class="flex items-center">
            <span class="text-sm font-medium text-gray-700 dark:text-gray-300 mr-2">Camera:</span>
            <span id="camera-status" class="text-sm font-semibold text-gray-500 dark:text-gray-400">‚ö™ OFF</span>
          </div>
          <div class="flex items-center">
            <span class="text-sm font-medium text-gray-700 dark:text-gray-300 mr-2">Recording:</span>
            <span id="recording-status" class="text-sm font-semibold text-gray-500 dark:text-gray-400">‚ö™ STOPPED</span>
          </div>
          <div id="duration-display" class="flex items-center hidden">
            <span class="text-sm font-medium text-gray-700 dark:text-gray-300 mr-2">Duration:</span>
            <span id="recording-duration" class="text-sm font-semibold text-red-600 dark:text-red-400">00:00:00</span>
          </div>
        </div>
      </div>
      
      <!-- Control Buttons -->
      <div class="flex space-x-3">
        <button id="turn-on-btn" type="button" class="text-white bg-green-600 hover:bg-green-700 focus:ring-4 focus:ring-green-300 font-medium rounded-lg text-sm px-5 py-2.5 dark:bg-green-500 dark:hover:bg-green-600 focus:outline-none dark:focus:ring-green-800">
          üì∑ Turn On Camera
        </button>
        <button id="turn-off-btn" type="button" disabled class="text-white bg-gray-400 font-medium rounded-lg text-sm px-5 py-2.5 cursor-not-allowed hidden">
          ‚èπ Turn Off Camera
        </button>
        <button id="start-rec-btn" type="button" disabled class="text-white bg-gray-400 font-medium rounded-lg text-sm px-5 py-2.5 cursor-not-allowed hidden">
          üî¥ Start Recording
        </button>
        <button id="stop-rec-btn" type="button" disabled class="text-white bg-gray-400 font-medium rounded-lg text-sm px-5 py-2.5 cursor-not-allowed hidden">
          ‚èπ Stop Recording
        </button>
        <button id="refresh-list-btn" type="button" class="text-gray-900 bg-white border border-gray-300 hover:bg-gray-100 focus:ring-4 focus:ring-gray-200 font-medium rounded-lg text-sm px-5 py-2.5 dark:bg-gray-800 dark:text-white dark:border-gray-600 dark:hover:bg-gray-700 dark:hover:border-gray-600 dark:focus:ring-gray-700">
          üîÑ Refresh List
        </button>
      </div>
    </div>
    
    <!-- Live Preview -->
    <div id="preview-container" class="bg-gray-900 shadow rounded-lg mb-6 hidden">
      <div class="p-4">
        <h2 class="text-lg font-semibold text-white mb-4">Live Preview</h2>
        <div class="flex justify-center bg-black rounded-lg overflow-hidden">
          <img id="webcam-preview" src="" alt="Webcam Preview" 
          class="max-w-full h-auto bg-black rounded-lg" 
          style="max-height: 600px; min-height: 200px; display: block;"
          onerror="this.style.opacity='0'" 
          onload="this.style.opacity='1'">
        </div>
        <p class="text-sm text-gray-400 mt-2 text-center">Streaming at ~30 FPS</p>
      </div>
    </div>
    
    <!-- Recordings List -->
    <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
      <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">üìπ Recorded Videos</h2>
      
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
          <thead class="bg-gray-50 dark:bg-gray-700">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                Date/Time
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                Filename
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                Duration
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                Size
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                Actions
              </th>
            </tr>
          </thead>
          <tbody id="recordings-list" class="bg-white divide-y divide-gray-200 dark:bg-gray-800 dark:divide-gray-700">
            <tr>
              <td colspan="5" class="px-6 py-4 text-center text-sm text-gray-500 dark:text-gray-400">
                No recordings yet. Start recording to create your first video.
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% endblock content %}


  {% block extra_js %}
  <script>
    let connectionState = {
    serverConnected: false,
    cameraOn: false,
    recording: false
  };

  
  document.addEventListener('DOMContentLoaded', function() {
    // ==================== DOM ELEMENTS ====================
    const turnOnBtn = document.getElementById('turn-on-btn');
    const turnOffBtn = document.getElementById('turn-off-btn');
    const startRecBtn = document.getElementById('start-rec-btn');
    const stopRecBtn = document.getElementById('stop-rec-btn');
    const refreshListBtn = document.getElementById('refresh-list-btn');
    
    const cameraStatus = document.getElementById('camera-status');
    const recordingStatus = document.getElementById('recording-status');
    const durationDisplay = document.getElementById('duration-display');
    const recordingDuration = document.getElementById('recording-duration');
    
    const previewContainer = document.getElementById('preview-container');
    const webcamPreview = document.getElementById('webcam-preview');
    const recordingsList = document.getElementById('recordings-list');

    // L·∫•y n√∫t Disconnect
    const disconnectBtn = document.getElementById('disconnect-server-btn');
    
    // ==================== STATE VARIABLES ====================
    let streamInterval = null;
    let durationInterval = null;
    let recordingStartTime = null;
    // let hasShownDisconnectAlert = false;
    let hasHandledDisconnect = false;


    // ‚è± STREAM WATCHDOG
    let lastFrameAt = Date.now();
    setInterval(() => {
      if (
        connectionState.serverConnected &&
        connectionState.cameraOn &&
        streamInterval &&
        Date.now() - lastFrameAt > 5000
      ) {
        console.warn('üö® Stream timeout (Lag) - Waiting for server...');
      }
    }, 1000);

    
    // ==================== UTILITY FUNCTIONS ====================
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    
    function showNotification(type, message) {
      const colors = {'success': '‚úì', 'error': '‚úó', 'info': '‚Ñπ'};
      alert(`${colors[type] || ''} ${message}`);
    }
    
    function updateDuration() {
      if (!recordingStartTime) return;
      const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
      const hours = Math.floor(elapsed / 3600);
      const minutes = Math.floor((elapsed % 3600) / 60);
      const seconds = elapsed % 60;
      recordingDuration.textContent = 
        `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    // function resetUIOnDisconnect() {
    //   if (hasShownDisconnectAlert) return;
    //   hasShownDisconnectAlert = true;

    //   connectionState.serverConnected = false;
    //   connectionState.cameraOn = false;
    //   connectionState.recording = false;

    //   stopStreaming();
    //   if (durationInterval) clearInterval(durationInterval);

    //   cameraStatus.textContent = '‚ö™ OFF (Disconnected)';
    //   recordingStatus.textContent = '‚ö™ STOPPED';

    //   previewContainer.classList.add('hidden');
    //   startRecBtn.classList.add('hidden');
    //   stopRecBtn.classList.add('hidden');
    //   durationDisplay.classList.add('hidden');

    //   // üî• QUAN TR·ªåNG
    //   turnOnBtn.disabled = false;
    //   turnOnBtn.classList.remove('hidden');

    //   turnOffBtn.disabled = true;
    //   turnOffBtn.classList.add('hidden'); // üëà FIX ·ªû ƒê√ÇY

    //   startRecBtn.disabled = true;
    //   stopRecBtn.disabled = true;

    //   showNotification('info', 'Disconnected from server. Please reconnect.');
    // }


    
    // ==================== CAMERA CONTROL ====================
    async function turnOnCamera() {
      turnOnBtn.disabled = true;
      turnOnBtn.textContent = 'Turning On...';
      
      try {
        const response = await fetch('/remote/api/webcam/on/', {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCookie('csrftoken')
          }
        });
        
        const data = await response.json();
        
        // Success ho·∫∑c camera ƒë√£ b·∫≠t r·ªìi ‚Üí Coi nh∆∞ th√†nh c√¥ng
        if (data.success || data.message.includes('already ON')) {
          hasHandledDisconnect = false;
          lastFrameAt = Date.now();
          connectionState.serverConnected = true;

          connectionState.cameraOn = true;
          cameraStatus.textContent = 'üü¢ ON';
          cameraStatus.classList.add('text-green-600');
          
          // Show preview and recording controls
          previewContainer.classList.remove('hidden');
          startRecBtn.classList.remove('hidden');
          
          // Enable buttons
          turnOnBtn.classList.add('hidden');


          turnOffBtn.disabled = false;
          turnOffBtn.classList.remove('bg-gray-400', 'cursor-not-allowed', 'hidden');
          turnOffBtn.classList.add('bg-red-600', 'hover:bg-red-700');
          
          startRecBtn.disabled = false;
          startRecBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
          startRecBtn.classList.add('bg-red-600', 'hover:bg-red-700');
          
          // Start streaming preview
          startStreaming();
          
          showNotification('success', data.success ? 'Camera turned on' : 'Camera already on, streaming started');
        } else {
          showNotification('error', data.message);
        }
      } catch (error) {
        showNotification('error', 'Failed to turn on camera: ' + error.message);
      } finally {
        turnOnBtn.disabled = false;
        turnOnBtn.textContent = 'üì∑ Turn On Camera';
      }
    }
    
    async function turnOffCamera() {
      stopStreaming();
      turnOffBtn.disabled = true;
      turnOffBtn.textContent = 'Turning Off...';
      
      try {
        // Stop recording if active
        if (connectionState.recording) {
          await stopRecording();
        }
        
        const response = await fetch('/remote/api/webcam/off/', {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCookie('csrftoken')
          }
        });
        
        const data = await response.json();
        
        if (data.success) {
          connectionState.cameraOn = false;
          connectionState.recording = false;
          cameraStatus.textContent = '‚ö™ OFF';
          cameraStatus.classList.remove('text-green-600');
          
          // Hide preview and recording controls
          previewContainer.classList.add('hidden');
          startRecBtn.classList.add('hidden');
          stopRecBtn.classList.add('hidden');
          
          // Update button states
          turnOffBtn.disabled = true;
          turnOffBtn.classList.add('bg-gray-400', 'cursor-not-allowed', 'hidden');
          turnOffBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
          
          turnOnBtn.disabled = false;
          turnOnBtn.classList.remove('bg-gray-400', 'cursor-not-allowed', 'hidden');
          turnOnBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
          
          // Stop streaming
          stopStreaming();
          
          showNotification('success', 'Camera turned off');
        } else {
          showNotification('error', data.message);
        }
      } catch (error) {
        showNotification('error', 'Failed to turn off camera: ' + error.message);
      } finally {
        turnOffBtn.textContent = '‚èπ Turn Off Camera';
      }
    }
    
    // ==================== STREAMING ====================
    function startStreaming() {
      if (streamInterval) return;

      streamInterval = setInterval(async () => {
        try {
          if (stopRecBtn.disabled && stopRecBtn.textContent === 'Stopping...') return;

          const response = await fetch('/remote/api/webcam/stream/');

          if (response.status === 204) {
            // Camera ch∆∞a b·∫≠t ‚Üí b√¨nh th∆∞·ªùng
            return;
          }

          if (!response.ok) {
            console.warn('Stream skipped frame'); 
            return;
          }

          const blob = await response.blob();
          if (blob.size > 0) {
            lastFrameAt = Date.now();
            const url = URL.createObjectURL(blob);
            webcamPreview.src = url;
            // Gi·ªØ URL l√¢u h∆°n ch√∫t ƒë·ªÉ ƒë·ª° nh√°y
            setTimeout(() => URL.revokeObjectURL(url), 500); 
          }

        } catch (err) {
          // S·ª¨A QUAN TR·ªåNG: ƒê·ª™NG G·ªåI handleServerDisconnected() ·ªû ƒê√ÇY
          // Khi server b·∫≠n l∆∞u file video n·∫∑ng, n√≥ c√≥ th·ªÉ timeout request n√†y.
          // H√£y ƒë·ªÉ polling status quy·∫øt ƒë·ªãnh vi·ªác disconnect.
          console.warn('Stream momentary error:', err.message);
        }
      }, 100); // 10 FPS l√† ƒë·ªß, ƒë·ª´ng 33ms
    }

    
    function stopStreaming() {
      if (streamInterval) {
        clearInterval(streamInterval);
        streamInterval = null;
      }
      // QUAN TR·ªåNG: X√≥a src c≈© ƒëi ƒë·ªÉ kh√¥ng hi·ªán c√°i icon ·∫£nh g√£y x·∫•u x√≠
      webcamPreview.src = ''; 
      webcamPreview.style.opacity = '0'; // ·∫®n ƒëi
    }
    
    // ==================== RECORDING CONTROL ====================
    async function startRecording() {
      if (!connectionState.cameraOn) {
        showNotification('error', 'Camera is off');
        return;
      }
      
      startRecBtn.disabled = true;
      startRecBtn.textContent = 'Starting...';
      
      try {
        const response = await fetch('/remote/api/webcam/start-recording/', {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCookie('csrftoken')
          }
        });
        
        const data = await response.json();
        
        if (data.success) {
          connectionState.recording = true;
          recordingStatus.textContent = 'üî¥ RECORDING';
          recordingStatus.classList.add('text-red-600');
          
          // Show duration and start timer
          durationDisplay.classList.remove('hidden');
          recordingStartTime = Date.now();
          durationInterval = setInterval(updateDuration, 1000);
          
          // Show stop button, hide start button
          startRecBtn.classList.add('hidden');
          stopRecBtn.classList.remove('hidden');
          stopRecBtn.disabled = false;
          stopRecBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
          stopRecBtn.classList.add('bg-red-600', 'hover:bg-red-700');
          
          showNotification('success', 'Recording started');
        } else {
          showNotification('error', data.message);
        }
      } catch (error) {
        showNotification('error', 'Failed to start recording: ' + error.message);
      } finally {
        startRecBtn.disabled = false;
        startRecBtn.textContent = 'üî¥ Start Recording';
      }
    }
    
    async function stopRecording() {
      stopStreaming(); 
      
      stopRecBtn.disabled = true;
      stopRecBtn.textContent = 'Stopping...';
      
      try {
        const response = await fetch('/remote/api/webcam/stop-recording/', {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCookie('csrftoken')
          }
        });
        
        const data = await response.json();
        
        if (data.success) {
          connectionState.recording = false;
          recordingStatus.textContent = '‚ö™ STOPPED';
          recordingStatus.classList.remove('text-red-600');
          
          // Hide duration
          durationDisplay.classList.add('hidden');
          if (durationInterval) {
            clearInterval(durationInterval);
            durationInterval = null;
          }
          recordingStartTime = null;
          recordingDuration.textContent = '00:00:00';
          
          // Show start button, hide stop button
          stopRecBtn.classList.add('hidden');
          startRecBtn.classList.remove('hidden');
          startRecBtn.disabled = false;
          
          // Refresh recordings list
          await loadRecordingsList();

          if (connectionState.cameraOn) {
             startStreaming();
          }
          
          showNotification('success', `Recording saved: ${data.file_size}`);
        } else {
          showNotification('error', data.message);
          if (connectionState.cameraOn) startStreaming();
        }
      } catch (error) {
        showNotification('error', 'Failed to stop recording: ' + error.message);
      } finally {
        stopRecBtn.disabled = false;
        stopRecBtn.textContent = '‚èπ Stop Recording';
      }
    }
    
    // ==================== RECORDINGS LIST ====================
    async function loadRecordingsList() {
      try {
        const response = await fetch('/remote/api/webcam/list/');
        const data = await response.json();
        
        if (data.success && data.recordings.length > 0) {
          recordingsList.innerHTML = data.recordings.map(rec => `
            <tr>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">
                ${rec.recorded_at}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                ${rec.filename}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                ${rec.duration}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                ${rec.file_size}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                <a href="${rec.file_url}" target="_blank" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 mr-3">View</a>
                <a href="${rec.file_url}" download class="text-green-600 hover:text-green-900 dark:text-green-400 mr-3">Download</a>
                <button onclick="deleteRecording(${rec.id})" class="text-red-600 hover:text-red-900 dark:text-red-400">Delete</button>
              </td>
            </tr>
          `).join('');
        } else {
          recordingsList.innerHTML = `
            <tr>
              <td colspan="5" class="px-6 py-4 text-center text-sm text-gray-500 dark:text-gray-400">
                No recordings yet. Start recording to create your first video.
              </td>
            </tr>
          `;
        }
      } catch (error) {
        console.error('Failed to load recordings:', error);
      }
    }
    
    window.deleteRecording = async function(id) {
      if (!confirm('Are you sure you want to delete this recording?')) return;
      
      try {
        const response = await fetch(`/remote/api/webcam/delete/${id}/`, {
          method: 'DELETE',
          headers: {
            'X-CSRFToken': getCookie('csrftoken')
          }
        });
        
        const data = await response.json();
        
        if (data.success) {
          showNotification('success', 'Recording deleted');
          await loadRecordingsList();
        } else {
          showNotification('error', data.message);
        }
      } catch (error) {
        showNotification('error', 'Failed to delete recording: ' + error.message);
      }
    };
    
    // ==================== STATUS POLLING ====================
    async function updateStatus() {
      try {
        const response = await fetch('/remote/api/webcam/status/');
        if (!response.ok) throw new Error('Server not reachable');

        connectionState.serverConnected = true;
        const data = await response.json();

        // ==== 1. TR·∫†NG TH√ÅI CAMERA (ON/OFF) ====
        if (data.camera_on !== connectionState.cameraOn) {
          connectionState.cameraOn = data.camera_on;

          // C·∫≠p nh·∫≠t ch·ªØ tr·∫°ng th√°i
          cameraStatus.textContent = data.camera_on ? 'üü¢ ON' : '‚ö™ OFF';
          cameraStatus.classList.toggle('text-green-600', data.camera_on);

          // ·∫®n/Hi·ªán khung h√¨nh
          previewContainer.classList.toggle('hidden', !data.camera_on);
          
          // --- C·∫¨P NH·∫¨T N√öT B·∫§M ---
          if (data.camera_on) {
              // 1. N√∫t Turn Off
              turnOnBtn.classList.add('hidden');
              turnOffBtn.classList.remove('hidden');
              turnOffBtn.disabled = false;
              turnOffBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
              turnOffBtn.classList.add('bg-red-600', 'hover:bg-red-700');
              
              // 2. N√∫t Start Recording (S·ª¨A L·∫†I ƒêO·∫†N N√ÄY)
              startRecBtn.classList.remove('hidden');
              
              // üëáüëáüëá TH√äM 3 D√íNG N√ÄY ƒê·ªÇ B·∫§M ƒê∆Ø·ª¢C üëáüëáüëá
              startRecBtn.disabled = false; 
              startRecBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
              startRecBtn.classList.add('bg-red-600', 'hover:bg-red-700');
              // üëÜüëÜüëÜ -------------------------------- üëÜüëÜüëÜ
              
              startStreaming(); 
          } else {
              // N·∫øu ƒëang OFF
              turnOnBtn.classList.remove('hidden');
              turnOffBtn.classList.add('hidden');
              
              startRecBtn.classList.add('hidden');
              stopRecBtn.classList.add('hidden');
              
              stopStreaming();
          }
        }
        
        // ==== 2. TR·∫†NG TH√ÅI RECORDING ====
        if (data.recording !== connectionState.recording) {
             connectionState.recording = data.recording;
             
             if (data.recording) {
                 recordingStatus.textContent = 'üî¥ RECORDING';
                 recordingStatus.classList.add('text-red-600');
                 
                 startRecBtn.classList.add('hidden');
                 stopRecBtn.classList.remove('hidden');
                 stopRecBtn.disabled = false;
             } else {
                 recordingStatus.textContent = '‚ö™ STOPPED';
                 recordingStatus.classList.remove('text-red-600');
                 
                 // N·∫øu cam ƒëang m·ªü th√¨ hi·ªán l·∫°i n√∫t Start
                 if (connectionState.cameraOn) {
                    startRecBtn.classList.remove('hidden');
                    // ƒê·∫£m b·∫£o n√∫t Start hi·ªán l·∫°i c≈©ng ph·∫£i b·∫•m ƒë∆∞·ª£c
                    startRecBtn.disabled = false;
                    startRecBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    startRecBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                 }
                 stopRecBtn.classList.add('hidden');
             }
        }

      } catch (err) {
        handleServerDisconnected();
      }
    }

    function handleServerDisconnected() {
      if (hasHandledDisconnect) return;
      hasHandledDisconnect = true;

      console.log('üö® Server disconnected ‚Üí force cleanup');

      // --- STATE ---
      connectionState.serverConnected = false;
      connectionState.cameraOn = false;
      connectionState.recording = false;

      // --- STOP STREAM ---
      stopStreaming();
      webcamPreview.src = '';
      lastFrameAt = 0;

      // --- STOP RECORD TIMER ---
      if (durationInterval) {
        clearInterval(durationInterval);
        durationInterval = null;
      }
      recordingStartTime = null;

      // --- RESET UI ---
      previewContainer.classList.add('hidden');
      startRecBtn.classList.add('hidden');
      stopRecBtn.classList.add('hidden');
      durationDisplay.classList.add('hidden');

      startRecBtn.disabled = true;
      stopRecBtn.disabled = true;

      turnOffBtn.disabled = true;
      turnOffBtn.classList.add('hidden');

      turnOnBtn.disabled = false;
      turnOnBtn.classList.remove('hidden');

      cameraStatus.textContent = '‚ö™ OFF (Disconnected)';
      recordingStatus.textContent = '‚ö™ STOPPED';

      showNotification(
        'info',
        'Disconnected from server.'
      );
    }




    
    // ==================== EVENT LISTENERS ====================
    turnOnBtn.addEventListener('click', turnOnCamera);
    turnOffBtn.addEventListener('click', turnOffCamera);
    startRecBtn.addEventListener('click', startRecording);
    stopRecBtn.addEventListener('click', stopRecording);
    refreshListBtn.addEventListener('click', loadRecordingsList);
    
    // TH√äM: Listen global event disconnect (n·∫øu button disconnect ·ªü base.html ho·∫∑c trang kh√°c)
    // Gi·∫£ s·ª≠ b·∫°n dispatch event 'server-disconnected' t·ª´ JS disconnect
    window.addEventListener('server-disconnected', handleServerDisconnected);
    
    // ==================== INITIALIZATION ====================
    // Load recordings list on page load
    loadRecordingsList();

    // ==================== FIX L·ªñI ·∫¢NH G√ÉY KHI CHUY·ªÇN TAB ====================
    document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') {
            // Khi ng∆∞·ªùi d√πng quay l·∫°i tab
            if (connectionState.cameraOn) {
                console.log('üëÅ Tab active -> Resume stream');
                // 1. C·∫≠p nh·∫≠t l·∫°i tr·∫°ng th√°i t·ª´ server xem cam c√≤n b·∫≠t kh√¥ng
                updateStatus(); 
                // 2. Kh·ªüi ƒë·ªông l·∫°i lu·ªìng stream m·ªõi
                startStreaming(); 
            }
        } else {
            // Khi ng∆∞·ªùi d√πng r·ªùi tab
            if (connectionState.cameraOn) {
                console.log('zzz Tab hidden -> Pause stream');
                // T·∫Øt stream ngay ƒë·ªÉ tr√°nh t√≠ch t·ª• l·ªói v√† ti·∫øt ki·ªám bƒÉng th√¥ng
                stopStreaming();
            }
        }
    });

    // ==================== H·∫æT PH·∫¶N FIX ====================
    
    // Initial status check
    updateStatus();

    // Poll status every 3 seconds
    setInterval(updateStatus, 3000);

    
  });
  </script>
  {% endblock extra_js %}
