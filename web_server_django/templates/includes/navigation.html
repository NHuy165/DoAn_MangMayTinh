{% load static %}

<nav class="fixed z-30 w-full bg-white border-b border-gray-200 dark:bg-gray-800 dark:border-gray-700">
    <div class="px-3 py-3 lg:px-5 lg:pl-3">
      <div class="flex items-center justify-between">
        <div class="flex items-center justify-start">
          <button id="toggleSidebarMobile" aria-expanded="true" aria-controls="sidebar"
            class="p-2 text-gray-600 rounded cursor-pointer lg:hidden hover:text-gray-900 hover:bg-gray-100 focus:bg-gray-100 dark:focus:bg-gray-700 focus:ring-2 focus:ring-gray-100 dark:focus:ring-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">
            <svg id="toggleSidebarMobileHamburger" class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"
              xmlns="http://www.w3.org/2000/svg">
              <path fill-rule="evenodd"
                d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h6a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z"
                clip-rule="evenodd"></path>
            </svg>
            <svg id="toggleSidebarMobileClose" class="hidden w-6 h-6" fill="currentColor" viewBox="0 0 20 20"
              xmlns="http://www.w3.org/2000/svg">
              <path fill-rule="evenodd"
                d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                clip-rule="evenodd"></path>
            </svg>
          </button>
          <a hx-get="/remote/home/" class="flex ml-2 md:mr-24">
            <img src="https://flowbite-admin-dashboard.vercel.app/images/logo.svg" class="h-8 mr-3"
              alt="FlowBite Logo" />
            <span
              class="self-center text-xl font-semibold sm:text-2xl whitespace-nowrap dark:text-white">Remote Administration Tool</span>
          </a>
    
          <!-- Server Selection (FORCE 1 ROW) -->
          <div class="flex items-center gap-2 ml-4 flex-nowrap">

            <!-- Select Server -->
            <div class="w-56 lg:w-64 min-w-0">
              <select
                id="server-select"
                class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg
                      focus:ring-primary-500 focus:border-primary-500 p-2.5
                      dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                <option value="" disabled selected>Select Server</option>
              </select>
            </div>

            <!-- Connect -->
            <button
              type="button"
              id="connect-server-btn"
              class="whitespace-nowrap
                    text-white bg-primary-700 hover:bg-primary-800
                    focus:ring-4 focus:ring-primary-300
                    font-medium rounded-lg text-sm px-5 py-2.5
                    dark:bg-primary-600 dark:hover:bg-primary-700 dark:focus:ring-primary-800">
              Connect
            </button>

            <!-- Disconnect -->
            <button
              type="button"
              id="disconnect-server-btn"
              class="hidden whitespace-nowrap
                    text-white bg-red-600 hover:bg-red-700
                    focus:ring-4 focus:ring-red-300
                    font-medium rounded-lg text-sm px-5 py-2.5
                    dark:bg-red-500 dark:hover:bg-red-600 dark:focus:ring-red-800">
              Disconnect
            </button>

            <!-- Discover -->
            <button
              type="button"
              id="discover-servers-btn"
              class="whitespace-nowrap
                    text-gray-900 bg-white border border-gray-300
                    hover:bg-gray-100 focus:ring-4 focus:ring-gray-200
                    font-medium rounded-lg text-sm px-5 py-2.5
                    dark:bg-gray-800 dark:text-white dark:border-gray-600
                    dark:hover:bg-gray-700 dark:focus:ring-gray-700">
              Discover
            </button>

          </div>

        </div>
        <div class="flex items-center">

          <button id="toggleSidebarMobileSearch" type="button"
            class="p-2 text-gray-500 rounded-lg lg:hidden hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">

            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
              <path fill-rule="evenodd"
                d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"
                clip-rule="evenodd"></path>
            </svg>
          </button>

          <button id="theme-toggle" data-tooltip-target="tooltip-toggle" type="button"
            class="text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 rounded-lg text-sm p-2.5">
            <svg id="theme-toggle-dark-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20"
              xmlns="http://www.w3.org/2000/svg">
              <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
            </svg>
            <svg id="theme-toggle-light-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20"
              xmlns="http://www.w3.org/2000/svg">
              <path
                d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"
                fill-rule="evenodd" clip-rule="evenodd"></path>
            </svg>
          </button>
          <div id="tooltip-toggle" role="tooltip"
            class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip">
            Toggle dark mode
            <div class="tooltip-arrow" data-popper-arrow></div>
          </div>

        </div>
      </div>
    </div>
</nav>
<!-- Add this style to ensure content is not hidden under the navigation bar -->
<style>
  /* Adjust this value if nav height changes significantly */
  .content-with-nav {
    padding-top: 4.5rem; /* Default nav height, increase if nav gets taller on mobile */
  }
  @media (max-width: 640px) {
    .content-with-nav {
      padding-top: 7.5rem; /* More space for taller nav on mobile */
    }
  }
</style>
<!--
  ƒê·ªÉ tr√°nh nav che m·∫•t n·ªôi dung, h√£y th√™m class "content-with-nav" v√†o th·∫ª div bao ngo√†i ph·∫ßn content ch√≠nh c·ªßa m·ªói page, v√≠ d·ª•:
  <div class="content-with-nav"> ... </div>
-->

<script>
  // Server discovery and connection functionality
  document.addEventListener('DOMContentLoaded', async function() {
    const serverSelect = document.getElementById('server-select');
    const connectBtn = document.getElementById('connect-server-btn');
    const disconnectBtn = document.getElementById('disconnect-server-btn');
    const discoverBtn = document.getElementById('discover-servers-btn');
    
    let availableServers = [];
    
    // ==================== CHECK SERVER RESTART ====================
    try {
      const response = await fetch('/remote/api/server-info/');
      const data = await response.json();
      const serverStartTime = data.start_time;
      const savedStartTime = localStorage.getItem('serverStartTime');
      
      if (savedStartTime && parseFloat(savedStartTime) !== serverStartTime) {
        console.log('üîÑ Server restarted ‚Üí Connection reset');
        localStorage.removeItem('connectedServer');
        localStorage.removeItem('connectionTime');
        localStorage.removeItem('discoveredServers');
      }
      
      localStorage.setItem('serverStartTime', serverStartTime.toString());
    } catch (error) {
      console.error('Server info check failed:', error);
    }
    
    // ==================== localStorage STATE MANAGEMENT ====================
    // L∆∞u/ƒë·ªçc tr·∫°ng th√°i k·∫øt n·ªëi t·ª´ localStorage ƒë·ªÉ t·ªìn t·∫°i qua c√°c l·∫ßn reload
    
    /**
     * L∆∞u th√¥ng tin server ƒëang k·∫øt n·ªëi v√†o localStorage
     * @param {Object} serverInfo - {ip, name}
     */
    function saveConnectionState(serverInfo) {
      localStorage.setItem('connectedServer', JSON.stringify(serverInfo));
      localStorage.setItem('connectionTime', new Date().toISOString());
    }
    
    /**
     * L·∫•y th√¥ng tin server ƒëang k·∫øt n·ªëi t·ª´ localStorage
     * @returns {Object|null} - {ip, name} ho·∫∑c null n·∫øu kh√¥ng c√≥
     */
    function getConnectionState() {
      const saved = localStorage.getItem('connectedServer');
      return saved ? JSON.parse(saved) : null;
    }
    
    /**
     * X√≥a tr·∫°ng th√°i k·∫øt n·ªëi kh·ªèi localStorage
     */
    function clearConnectionState() {
      localStorage.removeItem('connectedServer');
      localStorage.removeItem('connectionTime');
    }
    
    /**
     * Kh√¥i ph·ª•c UI t·ª´ localStorage khi page load
     * Hi·ªÉn th·ªã l·∫°i server ƒëang connect v√† button Disconnect
     */
    function restoreConnectionUI() {
      const connected = getConnectionState();
      
      if (connected) {
        // T·∫°o option cho server ƒëang connect
        serverSelect.innerHTML = '<option value="" disabled>Select Server</option>';
        const option = document.createElement('option');
        option.value = connected.ip;
        option.textContent = `${connected.name || connected.ip} (${connected.ip})`;
        option.selected = true;
        serverSelect.appendChild(option);
        
        // Hi·ªÉn th·ªã tr·∫°ng th√°i "Connected"
        connectBtn.classList.add('hidden');
        disconnectBtn.classList.remove('hidden');
        
        console.log(`‚úÖ Restored: ${connected.name || connected.ip}`);
      }
    }
    
    // Discover servers in LAN
    if (discoverBtn) {
      discoverBtn.addEventListener('click', async function() {
        discoverBtn.disabled = true;
        discoverBtn.textContent = 'Discovering...';
        
        try {
          const response = await fetch('/remote/api/discover-servers/', {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json'
            }
          });
          
          // Ki·ªÉm tra response c√≥ OK kh√¥ng
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          
          // Parse JSON response
          const data = await response.json();
          
          if (data.success) {
            availableServers = data.servers || [];
            localStorage.setItem('discoveredServers', JSON.stringify(availableServers));
            console.log(`üîç Discovered ${availableServers.length} server(s)`);
            
            updateServerList();
            showNotification('success', `Found ${availableServers.length} server(s)`);
          } else {
            showNotification('error', data.message || 'Failed to discover servers');
          }
        } catch (error) {
          showNotification('error', 'Error discovering servers: ' + error.message);
        } finally {
          discoverBtn.disabled = false;
          discoverBtn.textContent = 'Discover';
        }
      });
    }
    
    // Update server dropdown list
    function updateServerList() {
      const connected = getConnectionState();
      
      // N·∫øu ƒëang connected, gi·ªØ nguy√™n option c·ªßa server ƒëang connect
      if (connected) {
        serverSelect.innerHTML = '<option value="" disabled>Select Server</option>';
        const option = document.createElement('option');
        option.value = connected.ip;
        option.textContent = `${connected.name} (${connected.ip})`;
        option.selected = true;
        serverSelect.appendChild(option);
        return;
      }
      
      // Ch∆∞a connect ‚Üí Hi·ªÉn th·ªã danh s√°ch servers ƒë·ªÉ ch·ªçn
      serverSelect.innerHTML = '<option value="" disabled selected>Select Server</option>';
      
      if (availableServers.length === 0) {
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'No servers found';
        option.disabled = true;
        serverSelect.appendChild(option);
        return;
      }
      
      availableServers.forEach(server => {
        const option = document.createElement('option');
        option.value = server.ip;
        option.textContent = `${server.name || server.ip} (${server.ip})`;
        serverSelect.appendChild(option);
      });
    }
    
    // Connect to selected server
    if (connectBtn) {
      connectBtn.addEventListener('click', async function() {
        const selectedIp = serverSelect.value;
        
        if (!selectedIp) {
          showNotification('warning', 'Please select a server first');
          return;
        }
        
        connectBtn.disabled = true;
        connectBtn.textContent = 'Connecting...';
        
        try {
          const response = await fetch('/remote/api/connect-server/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ server_ip: selectedIp })
          });
          
          const data = await response.json();
          
          if (data.success) {
            showNotification('success', `Connected to ${selectedIp}`);
            
            const selectedServer = availableServers.find(s => s.ip === selectedIp);
            const serverInfo = {
              ip: selectedIp,
              name: selectedServer ? selectedServer.name : selectedIp
            };
            saveConnectionState(serverInfo);
            console.log(`‚úÖ Connected: ${serverInfo.name}`);
            
            // Update button to show connected state
            connectBtn.classList.remove('bg-primary-700', 'hover:bg-primary-800', 'dark:bg-primary-600', 'dark:hover:bg-primary-700');
            connectBtn.classList.add('bg-green-600', 'hover:bg-green-700', 'dark:bg-green-500', 'dark:hover:bg-green-600');
            connectBtn.textContent = 'Connected';
            // Show disconnect button, hide connect button
            connectBtn.classList.add('hidden');
            disconnectBtn.classList.remove('hidden');
          } else {
            showNotification('error', data.message || 'Failed to connect');
            connectBtn.textContent = 'Connect';
          }
        } catch (error) {
          showNotification('error', 'Connection error: ' + error.message);
          connectBtn.textContent = 'Connect';
        } finally {
          connectBtn.disabled = false;
        }
      });
    }
    
    // Disconnect from server
    // ==================== LOGIC DISCONNECT M·ªöI ====================
    // H√†m n√†y ƒë∆∞·ª£c g√°n v√†o window ƒë·ªÉ c√°c trang kh√°c (nh∆∞ Power) c√≥ th·ªÉ g·ªçi ƒë∆∞·ª£c
    window.handleClientDisconnect = function() {
        console.log('üîå Performing UI Disconnect...');
        
        // 1. X√≥a d·ªØ li·ªáu trong localStorage
        localStorage.removeItem('connectedServer');
        localStorage.removeItem('connectionTime');
        localStorage.removeItem('ACTIVE_STREAM_MODE'); // X√≥a c·ªù ƒëang stream n·∫øu c√≥
        sessionStorage.clear();

        // 2. C·∫≠p nh·∫≠t giao di·ªán n√∫t b·∫•m
        if (connectBtn && disconnectBtn && serverSelect) {
            // Reset Select Box
            serverSelect.innerHTML = '<option value="" disabled selected>Select Server</option>';
            
            // Hi·ªán n√∫t Connect, ·∫©n n√∫t Disconnect
            connectBtn.classList.remove('hidden', 'bg-green-600', 'dark:bg-green-500');
            connectBtn.classList.add('bg-primary-700', 'dark:bg-primary-600');
            connectBtn.textContent = 'Connect';
            disconnectBtn.classList.add('hidden');
            
            // Enable l·∫°i n√∫t Connect (ƒë·ªÅ ph√≤ng ƒëang b·ªã disable)
            connectBtn.disabled = false;
        }

        // 3. (T√πy ch·ªçn) Reload l·∫°i trang Home ƒë·ªÉ reset s·∫°ch s·∫Ω c√°c view
        // N·∫øu ƒëang d√πng HTMX
        if (typeof htmx !== 'undefined') {
             htmx.ajax('GET', '/remote/home/', '#main-content');
        }
    };
    
    
    if (disconnectBtn) {
      disconnectBtn.addEventListener('click', async function() {
        
        // Check Stream (Gi·ªØ nguy√™n logic b·∫£o v·ªá c≈© c·ªßa b·∫°n)
        const activeStream = localStorage.getItem('ACTIVE_STREAM_MODE');
        if (activeStream) {
            showNotification("warning", `‚ö†Ô∏è Cannot disconnect while ${activeStream} is active.`);
            return;
        }
        
        disconnectBtn.disabled = true;
        disconnectBtn.textContent = 'Disconnecting...';
        
        try {
          // G·ªçi API b√°o Server Python ng·∫Øt socket
          const response = await fetch('/remote/api/disconnect-server/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCookie('csrftoken')
            }
          });
          
          const data = await response.json();
          
          if (data.success) {
            showNotification("success", "üîå Disconnected successfully.");
            
            // G·ªåI H√ÄM D·ªåN D·∫∏P GIAO DI·ªÜN V·ª™A T·∫†O
            window.handleClientDisconnect();
            
          } else {
            showNotification("error", data.message || 'Failed to disconnect.');
            // N·∫øu l·ªói API, v·∫´n tr·∫£ l·∫°i tr·∫°ng th√°i n√∫t b·∫•m
            disconnectBtn.disabled = false;
            disconnectBtn.textContent = 'Disconnect';
          }
        } catch (error) {
          showNotification("error", 'Disconnect error: ' + error.message);
          disconnectBtn.disabled = false;
          disconnectBtn.textContent = 'Disconnect';
        }
      });
    }
    
    // Reset connect button when server selection changes
    if (serverSelect) {
      serverSelect.addEventListener('change', function() {
        connectBtn.classList.remove('bg-green-600', 'hover:bg-green-700', 'dark:bg-green-500', 'dark:hover:bg-green-600');
        connectBtn.classList.add('bg-primary-700', 'hover:bg-primary-800', 'dark:bg-primary-600', 'dark:hover:bg-primary-700');
        connectBtn.textContent = 'Connect';
      });
    }
    
    // Helper function to get CSRF token
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    

    
    // ==================== KH√îI PH·ª§C UI T·ª™ localStorage ====================
    // G·ªçi CU·ªêI C√ôNG sau khi t·∫•t c·∫£ event listeners ƒë√£ ƒë∆∞·ª£c ƒëƒÉng k√Ω
    // ƒê·∫£m b·∫£o c√°c button ƒë√£ s·∫µn s√†ng tr∆∞·ªõc khi restore UI
    restoreConnectionUI();
  });
</script>