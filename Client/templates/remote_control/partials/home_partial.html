<main data-page="home">
    <div class="px-4 pt-6">
        
        <div id="dash-disconnected"> 
            <div class="p-8 text-center bg-white border border-gray-200 rounded-lg shadow-sm dark:bg-gray-800 dark:border-gray-700">
                <div class="inline-flex items-center justify-center w-16 h-16 mb-4 bg-gray-100 rounded-full dark:bg-gray-700">
                    <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                </div>
                <h3 class="text-lg font-medium text-gray-900 dark:text-white">No Active Connection</h3>
                <p class="mt-2 text-gray-500 dark:text-gray-400">Please select a server and click "Connect" to view dashboard.</p>
            </div>
        </div>

        <div id="dash-connected" class="hidden space-y-4">
            <div class="p-4 bg-white border border-gray-200 rounded-lg shadow-sm dark:border-gray-700 dark:bg-gray-800">
                <div class="flex flex-wrap items-start justify-between gap-4">
                    <div class="min-w-0 flex-1">
                        <h2 class="flex items-center gap-3 text-2xl font-bold text-gray-900 dark:text-white truncate">
                            <span class="relative flex w-3 h-3 flex-shrink-0">
                              <span class="absolute inline-flex w-full h-full bg-green-400 rounded-full opacity-75 animate-ping"></span>
                              <span class="relative inline-flex w-3 h-3 bg-green-500 rounded-full"></span>
                            </span>
                            <span id="dash-hostname">Loading...</span>
                        </h2>
                        
                        <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-1 text-sm text-gray-500 dark:text-gray-400">
                            <div class="flex items-center gap-2 truncate">
                                <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"></path></svg>
                                <span id="dash-cpu-name" class="font-medium truncate" title="CPU Name">Checking CPU...</span>
                            </div>
                            <div class="flex items-center gap-2 truncate">
                                <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                                <span id="dash-os" class="truncate">Checking OS...</span>
                            </div>
                            <div class="flex items-center gap-2 truncate">
                                <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                <span id="dash-gpu-name" class="truncate" title="GPU Name">Checking GPU...</span>
                            </div>
                            <div class="flex items-center gap-2 truncate">
                                <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                <span>Uptime: <span id="dash-uptime" class="text-gray-900 dark:text-white font-bold">--</span></span>
                            </div>
                        </div>
                    </div>

                    <div class="text-right flex-shrink-0">
                        <div class="text-3xl font-bold text-green-500"><span id="dash-latency">--</span> <span class="text-sm font-normal text-gray-500">ms</span></div>
                        <div class="text-xs text-gray-400">Latency</div>
                        <div class="mt-2 text-xs font-mono text-gray-500 bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded inline-block" id="dash-ip">IP: ...</div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 gap-4 md:grid-cols-3">
                <div class="p-4 bg-white border border-gray-200 rounded-lg shadow-sm dark:bg-gray-800 dark:border-gray-700">
                    <div class="flex justify-between mb-2"><span class="text-sm font-medium text-gray-500 dark:text-gray-400">CPU Load</span></div>
                    <div class="flex items-baseline gap-2">
                        <span id="dash-cpu" class="text-3xl font-bold text-gray-900 dark:text-white">0</span><span class="text-sm">%</span>
                    </div>
                    <div class="w-full h-2.5 mt-3 bg-gray-200 rounded-full dark:bg-gray-700 overflow-hidden">
                        <div id="dash-cpu-bar" class="h-2.5 bg-blue-600 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>

                <div class="p-4 bg-white border border-gray-200 rounded-lg shadow-sm dark:bg-gray-800 dark:border-gray-700 flex flex-col justify-between">
                    <div>
                        <div class="flex justify-between mb-1"><span class="text-sm font-medium text-gray-500 dark:text-gray-400">Memory</span></div>
                        <div class="flex items-baseline gap-2">
                            <span id="dash-ram" class="text-2xl font-bold text-gray-900 dark:text-white">0</span>
                            <span class="text-xs text-gray-500">/ <span id="dash-ram-total">?</span> Free</span>
                        </div>
                    </div>
                    
                    <div class="w-full h-px bg-gray-200 dark:bg-gray-700 my-2"></div>

                    <div>
                        <div class="flex justify-between mb-1">
                            <span class="text-xs font-medium text-gray-500 dark:text-gray-400">Storage (All Drives)</span>
                            <span class="text-xs text-gray-900 dark:text-white font-bold" id="dash-disk">--</span>
                        </div>
                        <div class="w-full h-1.5 bg-gray-200 rounded-full dark:bg-gray-700">
                             <div class="h-1.5 bg-gray-400 rounded-full" style="width: 100%"></div> 
                        </div>
                    </div>
                </div>

                <div class="p-4 bg-white border border-gray-200 rounded-lg shadow-sm dark:bg-gray-800 dark:border-gray-700">
                    <div class="flex justify-between mb-2"><span class="text-sm font-medium text-gray-500 dark:text-gray-400">Battery</span></div>
                    <div class="flex items-baseline gap-2">
                        <span id="dash-battery" class="text-2xl font-bold text-gray-900 dark:text-white">--</span>
                    </div>
                    <p class="mt-2 text-xs text-gray-400">Power Status</p>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
    // 1. CLEAR TIMER CŨ NGAY LẬP TỨC
    if (window.homePollingTimer) {
        clearTimeout(window.homePollingTimer);
        window.homePollingTimer = null;
    }

    function initHomePage() {
        if (!document.querySelector('[data-page="home"]')) return;
        
        console.log("INIT HOME PAGE - Strict Sync Mode");

        const viewDisconnected = document.getElementById('dash-disconnected');
        const viewConnected = document.getElementById('dash-connected');

        function setUI(isConnected) {
            if (isConnected) {
                viewDisconnected.classList.add('hidden');
                viewConnected.classList.remove('hidden');
            } else {
                // Đảm bảo ẩn Connected trước
                viewConnected.classList.add('hidden'); 
                viewDisconnected.classList.remove('hidden');
            }
        }
        
        // Reset tất cả text về mặc định
        function resetDashboardUI() {
            const setText = (id, val) => { const el = document.getElementById(id); if(el) el.textContent = val; };
            setText('dash-hostname', 'Loading...');
            setText('dash-os', 'Checking OS...');
            setText('dash-ip', 'IP: ...');
            setText('dash-latency', '--');
            setText('dash-battery', '--');
            setText('dash-uptime', '--');
            setText('dash-cpu-name', 'Checking CPU...');
            setText('dash-gpu-name', 'Checking GPU...');
            setText('dash-ram', '0');
            setText('dash-ram-total', '?');
            setText('dash-disk', '--');
            setText('dash-cpu', '0');
            const bar = document.getElementById('dash-cpu-bar');
            if(bar) bar.style.width = '0%';
        }
        
        // QUAN TRỌNG: Kiểm tra localStorage NGAY LẬP TỨC khi init
        // Nếu không có connectedServer -> hiện Disconnected ngay, không cần fetch
        if (!localStorage.getItem('connectedServer')) {
            setUI(false);
            return; // Không cần làm gì thêm
        }
        
        // Có localStorage -> reset UI trước, rồi mới fetch validate
        // Điều này đảm bảo không hiện data cũ
        resetDashboardUI();

        async function fetchStats() {
            if (!document.querySelector('[data-page="home"]')) return;

            try {
                // Check localStorage mỗi lần fetch
                if (!localStorage.getItem('connectedServer')) {
                    setUI(false); 
                    return; 
                }

                const response = await fetch('/remote/api/stats/');
                
                // Nếu server Python restart, session mất -> fetch trả về lỗi hoặc json báo disconnected
                if (!response.ok) throw new Error("Server Error");
                
                const data = await response.json();

                if (data.status === 'success') {
                    updateDashboardData(data.data);
                    setUI(true); // Chỉ hiện khi có dữ liệu thật
                    
                    // Thành công thì mới hẹn giờ tiếp
                    window.homePollingTimer = setTimeout(fetchStats, 2000);

                } else {
                    // --- SỬA LỖI Ở ĐÂY: XỬ LÝ KHI SERVER BÁO LỖI/DISCONNECTED ---
                    console.warn("Server reported disconnection/error. Resetting UI.");
                    
                    // 1. Ẩn Dashboard ngay lập tức
                    setUI(false); 
                    
                    // 2. Xóa cờ trong localStorage để không bao giờ thử lại nữa
                    localStorage.removeItem('connectedServer');
                    localStorage.removeItem('connectionTime');
                    
                    // 3. Gọi hàm global để reset nút trên thanh điều hướng
                    if(window.handleClientDisconnect) window.handleClientDisconnect();
                }

            } catch (error) {
                console.log("Polling fail (Server likely dead):", error.message);
                
                // Nếu lỗi mạng nghiêm trọng (Python server tắt), coi như disconnect luôn
                setUI(false); 
                // Không xóa localStorage ngay nếu chỉ là lag mạng, 
                // nhưng nếu restart server thì fetch sẽ báo lỗi kết nối -> retry
                window.homePollingTimer = setTimeout(fetchStats, 2000);
            }
        }

        // Logic update dữ liệu (giữ nguyên)
        function updateDashboardData(data) {
            const setText = (id, val) => { const el = document.getElementById(id); if(el) el.textContent = val; };
            setText('dash-hostname', data.hostname);
            setText('dash-os', data.os_info);
            setText('dash-ip', data.internal_ip);
            setText('dash-latency', data.latency);
            setText('dash-battery', data.battery);
            setText('dash-uptime', data.uptime);
            setText('dash-cpu-name', data.cpu_name);
            const gpuText = data.gpu_name + (data.screen_res ? ` (${data.screen_res})` : "");
            setText('dash-gpu-name', gpuText);
            const gpuEl = document.getElementById('dash-gpu-name');
            if(gpuEl) gpuEl.title = gpuText;
            setText('dash-ram', data.ram_free);
            setText('dash-ram-total', data.ram_total);
            setText('dash-disk', data.disk_info);
            const cpu = parseFloat(data.cpu_load);
            setText('dash-cpu', cpu);
            const bar = document.getElementById('dash-cpu-bar');
            if(bar) {
                bar.style.width = `${Math.min(cpu, 100)}%`;
                let colorClass = "bg-blue-600";
                if(cpu > 80) colorClass = "bg-red-600";
                else if(cpu > 50) colorClass = "bg-yellow-500";
                bar.className = `${colorClass} h-2.5 rounded-full transition-all duration-500`;
            }
        }

        // --- KHỞI CHẠY ---
        // Nếu có cờ connectedServer, thử fetch để validate connection thật sự
        // fetch sẽ xác nhận connection có thật hay không
        fetchStats();
    }

    document.addEventListener('htmx:afterSwap', initHomePage);
    document.addEventListener('DOMContentLoaded', initHomePage);
</script>