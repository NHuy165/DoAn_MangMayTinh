<main data-page="applications">
    <div class="px-4 pt-6">
        <div class="grid gap-4 xl:grid-cols-1 2xl:grid-cols-2">
        <!-- Running Applications -->
        <div class="p-4 bg-white border border-gray-200 rounded-lg shadow-sm 2xl:col-span-2 dark:border-gray-700 sm:p-6 dark:bg-gray-800">
            <div class="flex items-center justify-between mb-4">
                <div class="flex-shrink-0">
                    <h3 class="mb-2 text-xl font-bold text-gray-900 dark:text-white">Running Applications</h3>
                </div>
                <div class="flex items-center">
                    <button onclick="loadApplications()" 
                        class="inline-flex items-center px-3 py-2 text-sm font-medium text-center text-white rounded-lg bg-primary-700 hover:bg-primary-800 focus:ring-4 focus:ring-primary-300 dark:bg-primary-600 dark:hover:bg-primary-700 dark:focus:ring-primary-800">
                        Refresh
                    </button>
                </div>
            </div>
            
            <div class="flex flex-col mt-6">
                <div class="overflow-x-auto rounded-lg" style="max-height: 500px; overflow-y: auto;">
                    <div class="inline-block min-w-full align-middle">
                        <div class="overflow-hidden shadow sm:rounded-lg">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-600">
                                <thead class="bg-gray-50 dark:bg-gray-700 sticky top-0 z-10">
                                    <tr>
                                        <th scope="col" class="p-4 text-xs font-medium tracking-wider text-left text-gray-500 uppercase dark:text-white">
                                            Application Name
                                        </th>
                                        <th scope="col" class="p-4 text-xs font-medium tracking-wider text-left text-gray-500 uppercase dark:text-white">
                                            Process ID
                                        </th>
                                        <th scope="col" class="p-4 text-xs font-medium tracking-wider text-left text-gray-500 uppercase dark:text-white">
                                            Threads
                                        </th>
                                        <th scope="col" class="p-4 text-xs font-medium tracking-wider text-left text-gray-500 uppercase dark:text-white">
                                            Action
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="runningAppsBody" class="bg-white dark:bg-gray-800">
                                    <tr>
                                        <td colspan="4" class="p-4 text-sm text-center text-gray-500 dark:text-gray-400">
                                            Click "Refresh" to load running applications
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Available Applications -->
        <div class="p-4 bg-white border border-gray-200 rounded-lg shadow-sm 2xl:col-span-2 dark:border-gray-700 sm:p-6 dark:bg-gray-800">
            <div class="items-center justify-between mb-4 lg:flex">
                <div class="mb-4 lg:mb-0">
                    <h3 class="mb-2 text-xl font-bold text-gray-900 dark:text-white">Available Applications (Start Menu)</h3>
                </div>
                <div class="flex items-center space-x-2">
                    <input type="text" id="searchApp" 
                        class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500"
                        placeholder="Search or enter app path...">
                    <button onclick="startNewApp()"
                        class="inline-flex items-center px-3 py-2 text-sm font-medium text-center text-white rounded-lg bg-green-600 hover:bg-green-700 focus:ring-4 focus:ring-green-300 dark:bg-green-500 dark:hover:bg-green-600 dark:focus:ring-green-800">
                        Start
                    </button>
                </div>
            </div>
            
            <div class="flex flex-col mt-6">
                <div class="overflow-x-auto rounded-lg" style="max-height: 400px; overflow-y: auto;">
                    <div class="inline-block min-w-full align-middle">
                        <div class="overflow-hidden shadow sm:rounded-lg">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-600">
                                <thead class="bg-gray-50 dark:bg-gray-700 sticky top-0 z-10">
                                    <tr>
                                        <th scope="col" class="p-4 text-xs font-medium tracking-wider text-left text-gray-500 uppercase dark:text-white">
                                            Application Name
                                        </th>
                                        <th scope="col" class="p-4 text-xs font-medium tracking-wider text-left text-gray-500 uppercase dark:text-white">
                                            Path
                                        </th>
                                        <th scope="col" class="p-4 text-xs font-medium tracking-wider text-left text-gray-500 uppercase dark:text-white">
                                            Action
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="availableAppsBody" class="bg-white dark:bg-gray-800">
                                    <tr>
                                        <td colspan="3" class="p-4 text-sm text-center text-gray-500 dark:text-gray-400">
                                            Click "Refresh" to load available applications
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
</main>

<script>
    // Cache danh sách Start Menu apps (để tránh load lại mỗi lần)
    // Dùng window scope để tránh lỗi "already declared" khi HTMX swap
    if (typeof window.cachedStartMenuApps_app === 'undefined') {
        window.cachedStartMenuApps_app = null;
    }

    // Load running applications
    async function loadApplications() {
        // Kiểm tra đã connect chưa
        if (!localStorage.getItem('connectedServer')) {
            showNotification("error", "Please connect to a server first");
            return;
        }
        
        const runningTbody = document.getElementById('runningAppsBody');
        const availableTbody = document.getElementById('availableAppsBody');
        runningTbody.innerHTML = '<tr><td colspan="4" class="p-4 text-sm text-center text-gray-500 dark:text-gray-400">Loading...</td></tr>';
        availableTbody.innerHTML = '<tr><td colspan="3" class="p-4 text-sm text-center text-gray-500 dark:text-gray-400">Loading Start Menu apps...</td></tr>';
        
        const data = await apiCall('/remote/api/app/list/');
        runningTbody.innerHTML = '';
        
        let runningAppNames = [];
        
        if (data.status === 'success' && data.data && data.data.length > 0) {
            data.data.forEach((app, index) => {
                const rowClass = index % 2 === 0 ? '' : 'bg-gray-50 dark:bg-gray-700';
                runningTbody.innerHTML += `
                    <tr class="${rowClass}">
                        <td class="p-4 text-sm font-normal text-gray-900 whitespace-nowrap dark:text-white">
                            ${app.name}
                        </td>
                        <td class="p-4 text-sm font-normal text-gray-500 whitespace-nowrap dark:text-gray-400">
                            ${app.id}
                        </td>
                        <td class="p-4 text-sm font-semibold text-gray-900 whitespace-nowrap dark:text-white">
                            ${app.threads}
                        </td>
                        <td class="p-4 whitespace-nowrap">
                            <button onclick="stopApp('${app.id}', '${app.name}')" 
                                class="inline-flex items-center px-3 py-2 text-sm font-medium text-center text-white bg-red-600 rounded-lg hover:bg-red-700 focus:ring-4 focus:ring-red-300 dark:bg-red-500 dark:hover:bg-red-600 dark:focus:ring-red-800">
                                End Task
                            </button>
                        </td>
                    </tr>`;
                
                // Lưu tên app đang chạy (lowercase để so sánh)
                runningAppNames.push(app.name.toLowerCase());
            });
            
            // Load available apps từ Start Menu
            await loadAvailableApps(runningAppNames);
        } else {
            runningTbody.innerHTML = '<tr><td colspan="4" class="p-4 text-sm text-center text-gray-500 dark:text-gray-400">No running applications or connection error</td></tr>';
            // QUAN TRỌNG: Không hiện available apps khi lỗi kết nối
            availableTbody.innerHTML = '<tr><td colspan="3" class="p-4 text-sm text-center text-gray-500 dark:text-gray-400">Connect to server and click Refresh to see available applications</td></tr>';
        }
    }

    // Load available applications từ Start Menu của server
    async function loadAvailableApps(runningAppNames = []) {
        const tbody = document.getElementById('availableAppsBody');
        
        // Lấy danh sách từ Start Menu (cache nếu đã có)
        if (!window.cachedStartMenuApps_app) {
            const startMenuData = await apiCall('/remote/api/app/start-menu/');
            if (startMenuData.status === 'success' && startMenuData.data) {
                window.cachedStartMenuApps_app = startMenuData.data;
            } else {
                tbody.innerHTML = '<tr><td colspan="3" class="p-4 text-sm text-center text-gray-500 dark:text-gray-400">Failed to load Start Menu apps</td></tr>';
                return;
            }
        }
        
        tbody.innerHTML = '';
        
        // Lọc các app chưa chạy
        const availableApps = window.cachedStartMenuApps_app.filter(app => {
            const appNameLower = app.name.toLowerCase();
            // Lấy tên file exe từ path
            const exeName = app.path.split('\\').pop().toLowerCase().replace('.exe', '');
            
            return !runningAppNames.some(running => 
                running.includes(appNameLower) || 
                running.includes(exeName) ||
                appNameLower.includes(running)
            );
        });
        
        if (availableApps.length > 0) {
            availableApps.forEach((app, index) => {
                const rowClass = index % 2 === 0 ? '' : 'bg-gray-50 dark:bg-gray-700';
                // Escape backslash và quotes trong path cho onclick
                const safePath = app.path.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
                tbody.innerHTML += `
                    <tr class="${rowClass}">
                        <td class="p-4 text-sm font-normal text-gray-900 whitespace-nowrap dark:text-white">
                            ${app.name}
                        </td>
                        <td class="p-4 text-sm font-normal text-gray-500 whitespace-nowrap dark:text-gray-400 truncate" style="max-width: 300px;" title="${app.path}">
                            ${app.path}
                        </td>
                        <td class="p-4 whitespace-nowrap">
                            <button onclick="startApp('${safePath}')" 
                                class="inline-flex items-center px-3 py-2 text-sm font-medium text-center text-white bg-red-600 rounded-lg hover:bg-red-700 focus:ring-4 focus:ring-red-300 dark:bg-red-500 dark:hover:bg-red-600 dark:focus:ring-red-800">
                                Start
                            </button>
                        </td>
                    </tr>`;
            });
        } else {
            tbody.innerHTML = '<tr><td colspan="3" class="p-4 text-sm text-center text-gray-500 dark:text-gray-400">All applications are already running</td></tr>';
        }
    }

    // Start application
    async function startApp(appPath) {
        const res = await apiCall('/remote/api/process/start/', 'POST', {name: appPath});
        
        if (res.status === 'success') {
            showNotification("success", res.message || 'Application started successfully');
            setTimeout(() => loadApplications(), 1500);
        } else {
            showNotification("error", res.message || 'Failed to start application');
        }
    }

    // Start new custom app
    async function startNewApp() {
        const path = document.getElementById('searchApp').value.trim();
        if (!path) {
            showNotification("error", 'Please enter application path');
            return;
        }
        
        await startApp(path);
        document.getElementById('searchApp').value = '';
    }

    // Stop application
    async function stopApp(id, name) {
        if (!confirm(`End task "${name}"?`)) {
            return;
        }
        
        const res = await apiCall('/remote/api/app/kill/', 'POST', {id: id});
        
        if (res.status === 'success') {
            showNotification("success", res.message || 'Application stopped successfully');
            setTimeout(() => loadApplications(), 1000);
        } else {
            showNotification("error", res.message || 'Failed to stop application');
        }
    }

    // Enter key handler
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('searchApp').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') startNewApp();
        });
        
        // Không load gì khi mới vào trang - chờ user bấm Refresh
    });
</script>

<script>
    // Common API call function
    async function apiCall(url, method='GET', body=null) {
        const options = { 
            method: method, 
            headers: {'Content-Type': 'application/json'} 
        };
        if (body) options.body = JSON.stringify(body);
        
        try {
            const res = await fetch(url, options);
            return await res.json();
        } catch (err) {
            console.error(err);
            return { status: 'error', message: 'Connection Error' };
        }
    }

</script>
