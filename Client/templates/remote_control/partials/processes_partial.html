<main data-page="processes">
    <div class="px-4 pt-6">
        <!-- Running Processes -->
        <div class="p-4 mb-4 bg-white border border-gray-200 rounded-lg shadow-sm dark:border-gray-700 sm:p-6 dark:bg-gray-800">
            <div class="items-center justify-between mb-4 lg:flex">
                <div class="mb-4 lg:mb-0">
                    <h3 class="mb-2 text-xl font-bold text-gray-900 dark:text-white">Running Processes</h3>
                </div>
                <div class="flex items-center">
                    <button onclick="loadProcesses()" 
                        class="inline-flex items-center px-3 py-2 text-sm font-medium text-center text-white rounded-lg bg-primary-700 hover:bg-primary-800 focus:ring-4 focus:ring-primary-300 dark:bg-primary-600 dark:hover:bg-primary-700 dark:focus:ring-primary-800">
                        Refresh
                    </button>
                </div>
            </div>
            
            <div class="flex flex-col mt-6">
                <div class="overflow-x-auto rounded-lg" style="max-height: 500px; overflow-y: auto;">
                    <div class="inline-block min-w-full align-middle">
                        <div class="overflow-hidden shadow sm:rounded-lg">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-600">
                                <thead class="bg-gray-50 dark:bg-gray-700 sticky top-0 z-10">
                                    <tr>
                                        <th scope="col" class="p-4 text-xs font-medium tracking-wider text-left text-gray-500 uppercase dark:text-white">
                                            Process Name
                                        </th>
                                        <th scope="col" class="p-4 text-xs font-medium tracking-wider text-left text-gray-500 uppercase dark:text-white">
                                            Process ID
                                        </th>
                                        <th scope="col" class="p-4 text-xs font-medium tracking-wider text-left text-gray-500 uppercase dark:text-white">
                                            Threads
                                        </th>
                                        <th scope="col" class="p-4 text-xs font-medium tracking-wider text-left text-gray-500 uppercase dark:text-white">
                                            Action
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="runningProcessesBody" class="bg-white dark:bg-gray-800">
                                    <tr>
                                        <td colspan="4" class="p-4 text-sm text-center text-gray-500 dark:text-gray-400">
                                            Click "Refresh" to load running processes
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Available Processes (Start Menu) -->
        <div class="p-4 bg-white border border-gray-200 rounded-lg shadow-sm dark:border-gray-700 sm:p-6 dark:bg-gray-800">
            <div class="items-center justify-between mb-4 lg:flex">
                <div class="mb-4 lg:mb-0">
                    <h3 class="mb-2 text-xl font-bold text-gray-900 dark:text-white">Available Processes (Start Menu)</h3>
                </div>
                <div class="flex items-center space-x-2">
                    <input type="text" id="searchProcess" 
                        class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500"
                        placeholder="Search or enter app path...">
                    <button onclick="startNewProcess()"
                        class="inline-flex items-center px-3 py-2 text-sm font-medium text-center text-white rounded-lg bg-green-600 hover:bg-green-700 focus:ring-4 focus:ring-green-300 dark:bg-green-500 dark:hover:bg-green-600 dark:focus:ring-green-800">
                        Start
                    </button>
                </div>
            </div>
            
            <div class="flex flex-col mt-6">
                <div class="overflow-x-auto rounded-lg" style="max-height: 400px; overflow-y: auto;">
                    <div class="inline-block min-w-full align-middle">
                        <div class="overflow-hidden shadow sm:rounded-lg">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-600">
                                <thead class="bg-gray-50 dark:bg-gray-700 sticky top-0 z-10">
                                    <tr>
                                        <th scope="col" class="p-4 text-xs font-medium tracking-wider text-left text-gray-500 uppercase dark:text-white">
                                            Application Name
                                        </th>
                                        <th scope="col" class="p-4 text-xs font-medium tracking-wider text-left text-gray-500 uppercase dark:text-white">
                                            Path
                                        </th>
                                        <th scope="col" class="p-4 text-xs font-medium tracking-wider text-left text-gray-500 uppercase dark:text-white">
                                            Action
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="availableProcessesBody" class="bg-white dark:bg-gray-800">
                                    <tr>
                                        <td colspan="3" class="p-4 text-sm text-center text-gray-500 dark:text-gray-400">
                                            Click "Refresh" to load available processes
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>


<script>
    // Cache danh sách Start Menu apps (để tránh load lại mỗi lần)
    // Dùng window scope để tránh lỗi "already declared" khi HTMX swap
    if (typeof window.cachedStartMenuApps_proc === 'undefined') {
        window.cachedStartMenuApps_proc = null;
    }

    // Load running processes
    async function loadProcesses() {
        // Kiểm tra đã connect chưa
        if (!localStorage.getItem('connectedServer')) {
            showNotification("error", "Please connect to a server first");
            return;
        }
        
        const runningTbody = document.getElementById('runningProcessesBody');
        const availableTbody = document.getElementById('availableProcessesBody');
        runningTbody.innerHTML = '<tr><td colspan="4" class="p-4 text-sm text-center text-gray-500 dark:text-gray-400">Loading...</td></tr>';
        availableTbody.innerHTML = '<tr><td colspan="3" class="p-4 text-sm text-center text-gray-500 dark:text-gray-400">Loading Start Menu apps...</td></tr>';
        
        const data = await apiCall('/remote/api/process/list/');
        runningTbody.innerHTML = '';
        
        let runningProcessNames = [];
        
        if (data.status === 'success' && data.data && data.data.length > 0) {
            data.data.forEach((proc, index) => {
                const rowClass = index % 2 === 0 ? '' : 'bg-gray-50 dark:bg-gray-700';
                runningTbody.innerHTML += `
                    <tr class="${rowClass}">
                        <td class="p-4 text-sm font-normal text-gray-900 whitespace-nowrap dark:text-white">
                            ${proc.name}
                        </td>
                        <td class="p-4 text-sm font-normal text-gray-500 whitespace-nowrap dark:text-gray-400">
                            ${proc.id}
                        </td>
                        <td class="p-4 text-sm font-semibold text-gray-900 whitespace-nowrap dark:text-white">
                            ${proc.threads}
                        </td>
                        <td class="p-4 whitespace-nowrap">
                            <button onclick="killProcess('${proc.id}', '${proc.name}')" 
                                class="inline-flex items-center px-3 py-2 text-sm font-medium text-center text-white bg-red-600 rounded-lg hover:bg-red-700 focus:ring-4 focus:ring-red-300 dark:bg-red-500 dark:hover:bg-red-600 dark:focus:ring-red-800">
                                End Task
                            </button>
                        </td>
                    </tr>`;
                
                // Lưu tên process đang chạy (lowercase để so sánh)
                runningProcessNames.push(proc.name.toLowerCase());
            });
            
            // Load available apps từ Start Menu
            await loadAvailableProcesses(runningProcessNames);
        } else {
            runningTbody.innerHTML = '<tr><td colspan="4" class="p-4 text-sm text-center text-gray-500 dark:text-gray-400">No running processes or connection error</td></tr>';
            // QUAN TRỌNG: Không hiện available processes khi lỗi kết nối
            availableTbody.innerHTML = '<tr><td colspan="3" class="p-4 text-sm text-center text-gray-500 dark:text-gray-400">Connect to server and click Refresh to see available processes</td></tr>';
        }
    }

    // Load available processes từ Start Menu của server
    async function loadAvailableProcesses(runningProcessNames = []) {
        const tbody = document.getElementById('availableProcessesBody');
        
        // Lấy danh sách từ Start Menu (cache nếu đã có)
        if (!window.cachedStartMenuApps_proc) {
            const startMenuData = await apiCall('/remote/api/app/start-menu/');
            if (startMenuData.status === 'success' && startMenuData.data) {
                window.cachedStartMenuApps_proc = startMenuData.data;
            } else {
                tbody.innerHTML = '<tr><td colspan="3" class="p-4 text-sm text-center text-gray-500 dark:text-gray-400">Failed to load Start Menu apps</td></tr>';
                return;
            }
        }
        
        tbody.innerHTML = '';
        
        // Lọc các app chưa chạy
        const availableApps = window.cachedStartMenuApps_proc.filter(app => {
            const appNameLower = app.name.toLowerCase();
            // Lấy tên file exe từ path
            const exeName = app.path.split('\\').pop().toLowerCase().replace('.exe', '');
            
            return !runningProcessNames.some(running => 
                running.includes(appNameLower) || 
                running.includes(exeName) ||
                appNameLower.includes(running)
            );
        });
        
        if (availableApps.length > 0) {
            availableApps.forEach((app, index) => {
                const rowClass = index % 2 === 0 ? '' : 'bg-gray-50 dark:bg-gray-700';
                // Escape backslash và quotes trong path cho onclick
                const safePath = app.path.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
                tbody.innerHTML += `
                    <tr class="${rowClass}">
                        <td class="p-4 text-sm font-normal text-gray-900 whitespace-nowrap dark:text-white">
                            ${app.name}
                        </td>
                        <td class="p-4 text-sm font-normal text-gray-500 whitespace-nowrap dark:text-gray-400 truncate" style="max-width: 300px;" title="${app.path}">
                            ${app.path}
                        </td>
                        <td class="p-4 whitespace-nowrap">
                            <button onclick="startProcess('${safePath}')" 
                                class="inline-flex items-center px-3 py-2 text-sm font-medium text-center text-white bg-red-600 rounded-lg hover:bg-red-700 focus:ring-4 focus:ring-red-300 dark:bg-red-500 dark:hover:bg-red-600 dark:focus:ring-red-800">
                                Start
                            </button>
                        </td>
                    </tr>`;
            });
        } else {
            tbody.innerHTML = '<tr><td colspan="3" class="p-4 text-sm text-center text-gray-500 dark:text-gray-400">All applications are already running</td></tr>';
        }
    }

    // Start process
    async function startProcess(appPath) {
        const res = await apiCall('/remote/api/process/start/', 'POST', {name: appPath});
        
        if (res.status === 'success') {
            showNotification("success", res.message || 'Process started successfully');
            setTimeout(() => loadProcesses(), 1500);
        } else {
            showNotification("error", res.message || 'Failed to start process');
        }
    }

    // Start new custom process
    async function startNewProcess() {
        const path = document.getElementById('searchProcess').value.trim();
        if (!path) {
            showNotification("error", 'Please enter application path');
            return;
        }
        
        await startProcess(path);
        document.getElementById('searchProcess').value = '';
    }

    // Kill process
    async function killProcess(pid, name) {
        if (!confirm(`End task "${name}" (Process ID: ${pid})?`)) {
            return;
        }
        
        const res = await apiCall('/remote/api/process/kill/', 'POST', {id: pid});
        
        if (res.status === 'success') {
            showNotification("success", res.message || 'Process terminated successfully');
            setTimeout(() => loadProcesses(), 1000);
        } else {
            showNotification("error", res.message || 'Failed to terminate process');
        }
    }

    // Enter key handler
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('searchProcess').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') startNewProcess();
        });
        
        // Không load gì khi mới vào trang - chờ user bấm Refresh
    });
</script>

<script>
    // Common API call function
    async function apiCall(url, method='GET', body=null) {
        const options = { 
            method: method, 
            headers: {'Content-Type': 'application/json'} 
        };
        if (body) options.body = JSON.stringify(body);
        
        try {
            const res = await fetch(url, options);
            return await res.json();
        } catch (err) {
            console.error(err);
            return { status: 'error', message: 'Connection Error' };
        }
    }

</script>