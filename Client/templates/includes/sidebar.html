<aside id="sidebar"
    class="fixed top-0 left-0 z-20 flex flex-col flex-shrink-0 hidden w-64 h-full pt-16 font-normal duration-75 lg:flex transition-width"
    aria-label="Sidebar">
    <div
        class="relative flex flex-col flex-1 min-h-0 pt-0 bg-white border-r border-gray-200 dark:bg-gray-800 dark:border-gray-700">
        <div class="flex flex-col flex-1 pt-5 pb-4 overflow-y-auto">
            <div class="flex-1 px-3 space-y-1 bg-white divide-y divide-gray-200 dark:bg-gray-800 dark:divide-gray-700">
                <ul class="pb-2 space-y-2">
                    <li>
                        <form action="#" method="GET" class="lg:hidden">
                            <label for="mobile-search" class="sr-only">Search</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                    <svg class="w-5 h-5 text-gray-500" fill="currentColor" viewBox="0 0 20 20"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path fill-rule="evenodd"
                                            d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"
                                            clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                                <input type="text" name="email" id="mobile-search"
                                    class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full pl-10 p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-gray-200 dark:focus:ring-primary-500 dark:focus:border-primary-500"
                                    placeholder="Search">
                            </div>
                        </form>
                    </li>

                    <li>
                        <button hx-get="/remote/home/"
                            hx-target="#main-content"
                            hx-swap="innerHTML"
                            hx-push-url="true"
                            class="w-full text-left cursor-pointer flex items-center p-2 text-base text-gray-900 rounded-lg hover:bg-gray-100 group dark:text-gray-200 dark:hover:bg-gray-700">
                            <svg class="w-6 h-6 text-gray-500 transition duration-75 group-hover:text-gray-900 dark:text-gray-400 dark:group-hover:text-white"
                                fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                <path d="M2 10a8 8 0 018-8v8h8a8 8 0 11-16 0z"></path>
                                <path d="M12 2.252A8.014 8.014 0 0117.748 8H12V2.252z"></path>
                            </svg>
                            <span class="ml-3" sidebar-toggle-item>Home</span>
                        </button>
                    </li>
                    
                    <li>
                        <button hx-get="/remote/applications/"
                            hx-target="#main-content"
                            hx-swap="innerHTML"
                            hx-push-url="true"
                            class="w-full text-left cursor-pointer flex items-center p-2 text-base text-gray-900 rounded-lg hover:bg-gray-100 group dark:text-gray-200 dark:hover:bg-gray-700">
                            <svg class="w-6 h-6 text-gray-500 transition duration-75 group-hover:text-gray-900 dark:text-gray-400 dark:group-hover:text-white"
                                fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v12a1 1 0 01-1 1H4a1 1 0 01-1-1V3zm3 2h8v8H6V5z" clip-rule="evenodd"/>
                            </svg>
                            <span class="ml-3" sidebar-toggle-item>Application</span>
                        </button>
                    </li>

                    <li>
                        <button hx-get="/remote/processes/"
                            hx-target="#main-content"
                            hx-swap="innerHTML"
                            hx-push-url="true"
                            class="w-full text-left cursor-pointer flex items-center p-2 text-base text-gray-900 rounded-lg hover:bg-gray-100 group dark:text-gray-200 dark:hover:bg-gray-700">
                            <svg class="w-6 h-6 text-gray-500 transition duration-75 group-hover:text-gray-900 dark:text-gray-400 dark:group-hover:text-white"
                                fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm9.707 5.707a1 1 0 00-1.414-1.414L9 12.586l-1.293-1.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                            </svg>
                            <span class="ml-3" sidebar-toggle-item>Process</span>
                        </button>
                    </li>

                    <li>
                        <button hx-get="/remote/shell/"
                            hx-target="#main-content"
                            hx-swap="innerHTML"
                            hx-push-url="true"
                            class="w-full text-left cursor-pointer flex items-center p-2 text-base text-gray-900 rounded-lg hover:bg-gray-100 group dark:text-gray-200 dark:hover:bg-gray-700">
                            <svg class="w-6 h-6 text-gray-500 transition duration-75 group-hover:text-gray-900 dark:text-gray-400 dark:group-hover:text-white"
                                fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd" d="M2 5a2 2 0 012-2h12a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2V5zm3.293 1.293a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 01-1.414-1.414L7.586 10 5.293 7.707a1 1 0 010-1.414zM11 12a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                            <span class="ml-3" sidebar-toggle-item>Terminal</span>
                        </button>
                    </li>

                    <li>
                        <button hx-get="/remote/screenshot/"
                            hx-target="#main-content"
                            hx-swap="innerHTML"
                            hx-push-url="true"
                            class="w-full text-left cursor-pointer flex items-center p-2 text-base text-gray-900 rounded-lg hover:bg-gray-100 group dark:text-gray-200 dark:hover:bg-gray-700">
                            <svg class="w-6 h-6 text-gray-500 transition duration-75 group-hover:text-gray-900 dark:text-gray-400 dark:group-hover:text-white"
                                fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/>
                            </svg>
                            <span class="ml-3" sidebar-toggle-item>Screenshot</span>
                        </button>
                    </li>

                    <li>
                        <button hx-get="/remote/screen/"
                            hx-target="#main-content"
                            hx-swap="innerHTML"
                            hx-push-url="true"
                            onclick="return validateStreamNavigation(event, 'WEBCAM', 'Webcam đang chạy! Vui lòng tắt Webcam trước khi chuyển sang Quay màn hình.')"
                            class="w-full text-left cursor-pointer flex items-center p-2 text-base text-gray-900 rounded-lg hover:bg-gray-100 group dark:text-gray-200 dark:hover:bg-gray-700">
                            <svg class="w-6 h-6 text-gray-500 transition duration-75 group-hover:text-gray-900 dark:text-gray-400 dark:group-hover:text-white"
                                fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/>
                            </svg>
                            <span class="ml-3" sidebar-toggle-item>Screen Recorder</span>
                        </button>
                    </li>

                    <li>
                        <button hx-get="/remote/keylogger/"
                            hx-target="#main-content"
                            hx-swap="innerHTML"
                            hx-push-url="true"
                            class="w-full text-left cursor-pointer flex items-center p-2 text-base text-gray-900 rounded-lg hover:bg-gray-100 group dark:text-gray-200 dark:hover:bg-gray-700">
                            <svg class="w-6 h-6 text-gray-500 transition duration-75 group-hover:text-gray-900 dark:text-gray-400 dark:group-hover:text-white"
                                fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                <path d="M2 5a2 2 0 012-2h12a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2V5zm3 1h10v2H5V6zm0 4h10v2H5v-2zm0 4h6v2H5v-2z"/>
                            </svg>
                            <span class="ml-3" sidebar-toggle-item>Keylogger</span>
                        </button>
                    </li>

                    <li>
                        <button hx-get="/remote/webcam/"
                            hx-target="#main-content"
                            hx-swap="innerHTML"
                            hx-push-url="true"
                            onclick="return validateStreamNavigation(event, 'SCREEN', 'Screen Recording đang chạy! Vui lòng tắt quay màn hình trước khi bật Webcam.')"
                            class="w-full text-left cursor-pointer flex items-center p-2 text-base text-gray-900 rounded-lg hover:bg-gray-100 group dark:text-gray-200 dark:hover:bg-gray-700">
                            <svg class="w-6 h-6 text-gray-500 transition duration-75 group-hover:text-gray-900 dark:text-gray-400 dark:group-hover:text-white"
                                fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z"/>
                            </svg>
                            <span class="ml-3" sidebar-toggle-item>Webcam</span>
                        </button>
                    </li>

                    <li>
                        <a href="{% url 'remote_control:file_manager' %}"
                            class="flex items-center p-2 text-base text-gray-900 rounded-lg hover:bg-gray-100 group dark:text-gray-200 dark:hover:bg-gray-700">
                            <svg class="w-6 h-6 text-gray-500 transition duration-75 group-hover:text-gray-900 dark:text-gray-400 dark:group-hover:text-white"
                                fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1H8a3 3 0 00-3 3v1.5a1.5 1.5 0 01-3 0V6z" clip-rule="evenodd"></path>
                                <path d="M6 12a2 2 0 012-2h8a2 2 0 012 2v2a2 2 0 01-2 2H2h2a2 2 0 002-2v-2z"></path>
                            </svg>
                            <span class="ml-3" sidebar-toggle-item>File Manager</span>
                        </a>
                    </li>

                    <li>
                        <button hx-get="/remote/power/"
                            hx-target="#main-content"
                            hx-swap="innerHTML"
                            hx-push-url="true"
                            class="w-full text-left cursor-pointer flex items-center p-2 text-base text-gray-900 rounded-lg hover:bg-gray-100 group dark:text-gray-200 dark:hover:bg-gray-700">
                            <svg class="w-6 h-6 text-gray-500 transition duration-75 group-hover:text-gray-900 dark:text-gray-400 dark:group-hover:text-white"
                                fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v6a1 1 0 11-2 0V3a1 1 0 011-1zm5.293 2.293a1 1 0 011.414 1.414l-3 3a1 1 0 01-1.414-1.414l3-3zM4.707 4.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414-1.414l-3-3z" clip-rule="evenodd"/>
                            </svg>
                            <span class="ml-3" sidebar-toggle-item>Power</span>
                        </button>
                    </li>
        </div>
    </div>

<script>
        /**
         * Hàm kiểm tra trạng thái Stream thật sự từ Server
         * Chạy TỰ ĐỘNG ngay khi trang load để dọn dẹp các trạng thái "Zombie" (cũ)
         */
        (function checkAndCleanStaleState() {
            const currentMode = localStorage.getItem('ACTIVE_STREAM_MODE');
            
            // Nếu không có mode nào đang được lưu, không cần làm gì
            if (!currentMode) return;
            
            console.log("Checking stream state sanity for:", currentMode);
            
            // Map mode sang API endpoint để check
            let url = '';
            if (currentMode === 'SCREEN') url = '/remote/api/screen/status';
            else if (currentMode === 'WEBCAM') url = '/remote/api/webcam/status';
            
            if(url) {
                fetch(url)
                    .then(r => r.json())
                    .then(data => {
                        // Nếu server báo là KHÔNG quay (rec=false), mà localStorage đang lưu là CÓ
                        // HOẶC nếu cả hai đều tắt (on=false, rec=false)
                        // -> Nghĩa là trạng thái trong Browser là "Zombie" -> Xóa ngay
                        if (!data.rec) {
                            console.warn("Found stale state (Server: Not Rec, Local: " + currentMode + "). Clearing...");
                            localStorage.removeItem('ACTIVE_STREAM_MODE');
                        }
                    })
                    .catch(e => {
                        // Nếu lỗi kết nối (ví dụ: chưa connect server) -> Xóa luôn cho an toàn
                        // Để người dùng còn thao tác được
                        console.error("Connection check failed/Not connected. Resetting state.", e);
                        localStorage.removeItem('ACTIVE_STREAM_MODE');
                    });
            }
        })();

        /**
        * Hàm kiểm tra xung đột Stream
        * Được gọi trực tiếp trong sự kiện onclick
        */
        function validateStreamNavigation(event, conflictMode, message) {
            const currentMode = localStorage.getItem('ACTIVE_STREAM_MODE');

            if (currentMode === conflictMode) {
                alert(message);
                
                // Ngăn chặn sự kiện lan tỏa
                event.preventDefault();
                event.stopPropagation();
                if (event.stopImmediatePropagation) {
                    event.stopImmediatePropagation();
                }
                return false;
            }
            return true;
        }

        document.body.addEventListener('htmx:beforeRequest', function(evt) {
            let trigger = evt.detail.elt;
            let path = trigger.getAttribute('hx-get');
            let currentMode = localStorage.getItem('ACTIVE_STREAM_MODE');

            if (path && path.includes('/remote/webcam/') && currentMode === 'SCREEN') {
                alert('Screen Recording đang chạy! Vui lòng tắt quay màn hình trước khi bật Webcam.');
                evt.preventDefault();
            }
            
            if (path && path.includes('/remote/screen/') && currentMode === 'WEBCAM') {
                alert('Webcam đang chạy! Vui lòng tắt Webcam trước khi chuyển sang Quay màn hình.');
                evt.preventDefault();
            }
        });
    </script>
</aside>